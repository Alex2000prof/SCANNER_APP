<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>На МП</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- Подключаем SweetAlert2 для модальных окон -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"> -->


  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
    html, body {
      font-family: 'Montserrat', sans-serif;
    }
    html, body {
    overflow-x: hidden;
    margin: 0;
    padding: 0;
   }
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }
    .transfer-container {
      width: 90%;
      max-width: 600px;
      background: #fff;
      border: 1px solid #ff3c00;
      border-radius: 0px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
      position: relative;
      padding: 20px 20px 60px 20px;
    }
    /* Info-кнопка в самом верхнем правом углу */
    .info-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      background: linear-gradient(135deg, #ff3c00, #ff7733);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.5em;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.3s;
      z-index: 3;
    }
    .info-icon:hover {
      background: linear-gradient(135deg, #e04400, #ff5733);
    }
    /* Popup с информацией */
    .info-popup {
      display: none;
      position: absolute;
      top: 60px;
      right: 10px;
      background: linear-gradient(135deg, #fff, #f0f0f0);
      border: 2px solid #ff3c00;
      border-radius: 8px;
      padding: 10px;
      width: 260px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 3;
    }
    .info-popup h3 {
      margin: 0 0 5px;
      font-size: 1.2em;
      color: #ff3c00;
    }
    .info-popup p {
      margin: 3px 0;
      font-size: 1em;
      color: #333;
    }
    .info-popup .close-popup {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      color: #ff3c00;
    }
    .header-info {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #ccc;
    }

    .static-header {
      font-size: 1.5em;
      color: #ff3c00;
      line-height: 1.1;  /* чуть плотнее строки */
      text-align: center;
    }

    .warehouse-task-number,
    .doc-info,
    .remaining-tasks {
      font-size: 1.2em;
      margin: 3px 0;
      color: #333;
      font-weight: 600;
    }
    /* Информация о товаре */
    .product-info {
      text-align: center;
      font-size: 1.2em;
      color: #555;
      margin-bottom: 10px;
    }
    .product-info span {
      display: block;
    }
    /* Секции */
    .transfer-section {
      margin-bottom: 15px;
      padding: 20px;
      background: linear-gradient(135deg, #fafafa, #f0f0f0);
      border: 2px solid #ccc;
      border-radius: 8px;
      transition: border-color 0.3s, background 0.3s, color 0.3s;
      position: relative;
    }
    .transfer-section.active {
      border-color: #FFD700;
      background: linear-gradient(135deg, #fff8e1, #fff3cd);
      color: #444;
    }
    .transfer-section.confirmed {
      color: #333 !important;
      border-color: #28a745;
      background: linear-gradient(135deg, #eaffea, #d4f7d4);
      color: #fff;
    }
    .transfer-section h2 {
      margin: 0 0 10px;
      font-size: 1.4em;
      color: inherit;
      text-align: center;
      border-bottom: 2px solid #ccc;
      padding-bottom: 5px;
    }

    /* Ручной ввод */
    .manual-input {
      display: none;
      margin-top: 10px;
      text-align: center;
    }
    .manual-input input {
      padding: 8px;
      font-size: 1em;
      border: 2px solid #ff3c00;
      border-radius: 4px;
      width: 60%;
      margin-bottom: 5px;
    }
    .manual-input button {
      padding: 8px 15px;
      font-size: 1em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 5px;
      background: linear-gradient(135deg, #FF3366, #FF7733);
      color: #fff;
      transition: background 0.3s;
    }
    .manual-input button:hover {
      background: linear-gradient(135deg, #FF2255, #FF6633);
    }
    /* Информационные блоки */
    .info-block {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1em;
      font-weight: bold;
      color: inherit;
    }
    .cell-highlight {
      display: block;
      font-size: 2em;
      font-weight: bold;
      padding: 10px 20px;
      background-color: #ff3c00;
      color: #fff;
      border-radius: 8px;
      margin: 5px auto;
      transition: background-color 0.3s;
    }
    .confirmed-cell {
      background-color: #28a745 !important;
    }
    .status-text {
      text-align: center;
      font-size: 1.1em;
      color: #888;
      margin-top: 5px;
    }
    /* Карточки для информации (Артикул, Ра/Ро, Штук) */
    .info-cards {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .info-card {
      background: #ff3c00;
      color: #fff;
      border-radius: 8px;
      width: 100px;
      height: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
      transition: background 0.3s;
    }
    .info-card:hover {
      background: #ff5722;
    }
    .card-label {
      font-size: 0.7em;
      opacity: 0.9;
    }
    .card-value {
      font-size: 1.1em;
      font-weight: bold;
      margin-top: 3px;
    }
    /* Блок "Количество" */
    .quantity-block {
      text-align: center;
      margin-top: 15px;
      position: relative;
    }
    .quantity-block input[type="number"] {
      width: 100px;
      padding: 10px;
      font-size: 1.3em;
      border: 2px solid #ccc;
      border-radius: 6px;
      margin-right: 10px;
      transition: border-color 0.3s;
    }
    .quantity-block input[type="number"]:focus {
      border-color: #ff3c00;
      outline: none;
    }
    .quantity-block .btn {
      padding: 10px 20px;
      font-size: 1.3em;
      background: linear-gradient(135deg, #FF3366, #FF7733);
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: background 0.3s, transform 0.2s;
    }
    .quantity-block .btn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .quantity-block .btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #FF2255, #FF6633);
      transform: translateY(-2px);
    }
    .back-btn-qty {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6a00, #ee0979);
      color: #fff;
      font-size: 1.8em;
      cursor: pointer;
      outline: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background 0.3s, transform 0.2s;
    }
    .back-btn-qty:hover {
      background: linear-gradient(135deg, #e05500, #d80a70);
      transform: scale(1.05);
    }
    /* Нижний блок кнопок */
    .bottom-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      gap: 20px;
    }
    .back-btn, .skip-btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 1.1em;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.3s;
      flex: 1;
      text-align: center;
    }
    .back-btn {
      background: #333;
      color: #fff;
    }
    .back-btn:hover {
      background: #555;
    }
    .skip-btn {
      background: #007bff;
      color: #fff;
      border: none;
    }
    .skip-btn:hover {
      background: #0056b3;
    }

    /* 1) Общий стиль для кнопок внутри секций */
.transfer-section .section-info,
.transfer-section .edit-btn {
  position: absolute;
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #ff3c00, #ff7733);
  color: #fff;
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2em;
  cursor: pointer;
  transition: transform .2s, background .2s;
  z-index: 10;
}
/* info слева, edit справа */
.transfer-section .section-info {
  top: 8px;
  left: 8px;
}
.transfer-section .edit-btn {
  top: 8px;
  right: 8px;
}
/* hover‑эффект */
.transfer-section .section-info:hover,
.transfer-section .edit-btn:hover {
  transform: scale(1.1);
  background: linear-gradient(135deg, #e04400, #ff5733);
}

/* 2) Красивый, лёгкий popup‑блок */
.section-popup {
  display: none;
  position: absolute;
  border: 1.5px solid #ff3c00;
  top: 42px;        /* под 32px‑кнопкой + 8px отступ */
  left: 8px;        /* совпадает с левым отступом кнопки ❔ */
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
  padding: 12px;
  z-index: 20;
  min-width: 200px;
}

/* Таблица внутри pop‑up, зебра‑шаблон, читаемость */
.section-popup table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9em;
}
.section-popup th,
.section-popup td {
  padding: 8px 10px;
  text-align: left;
}
.section-popup th {
  background: #ff3c00;
  color: #fff;
  font-weight: 600;
  border-bottom: 2px solid #e0e0e0;
}
.section-popup tr:nth-child(odd) {
  background: #f9f9f9;
}
.section-popup tr:nth-child(even) {
  background: #fff;
}
.filter-btn {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 42px;
  height: 42px;
  background: linear-gradient(135deg,#ff3c00,#ff7733);
  border: none;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  z-index: 10;
}
.filter-btn svg {
  width: 22px;
  height: 22px;
  fill: #fff;
}
.filter-menu {
  display: none;
  position: absolute;
  top: 60px;
  left: 10px;
  background: #fff;
  border: 2px solid #ff3c00;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,.2);
  z-index: 99;
  padding: 8px 0;
  min-width: 240px;
}
.filter-option {
  padding: 12px 16px;
  font-size: 1rem;
  color: #333;
  cursor: pointer;
  transition: background 0.2s ease;
}
.filter-option:hover {
  background: #ffe0d3;
}
.filter-choice {
    display: block;
    background: linear-gradient(135deg, #ff3c00, #ff7733);
    color: #fff;
    font-weight: 600;
    text-align: center;
    text-decoration: none;
    border-radius: 10px;
    padding: 12px;
    margin: 6px 0;
    transition: background 0.3s, transform 0.2s;
  }
  .filter-choice:hover {
    background: linear-gradient(135deg, #e04400, #ff5733);
    transform: scale(1.05);
  }
  
  .circle-back {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(135deg, #ff3c00, #ff7733);
  color: #fff;
  font-size: 1.2em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}


/* Класс для скрытия блока */
.hidden {
  display: none;
}

/* Класс для «затемнения» блока Количество */
/* Гасим только блок сканирования */
.scan-block.grayed {
  opacity: 0.5;
  pointer-events: none;
}
/* Но кнопку "Очистить" оставляем активной */
.scan-block.grayed #clearScansBtn {
  opacity: 1 !important;
  pointer-events: auto !important;
}

/* Центрируем и подравниваем кнопки */
.done-block,
.next-block {
  text-align: center;
  margin-bottom: 10px;
}
.next-block {
  margin-top: 10px;
}
.next-block .btn-primary {
  min-width: 160px;
}

/* Контейнер всех трёх кнопок */
.buttons-block {
  width: 100%;
  max-width: 600px;
  margin: 0 auto 2em;
  box-sizing: border-box;
}

/* Первый ряд: две кнопки рядом */
.buttons-row {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}
.buttons-row a {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  padding: .8em 0;
  border-radius: 6px;
  color: #fff;
  font-size: 1.2em;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  transition: background .3s, transform .1s;
}

/* Градиентная кнопка */
.btn-primary {
  background: linear-gradient(135deg, #33a7ff, #a0e1ff);
  font-size: 1.1em;      /* текст крупнее */
  padding: 0.8em 1.2em;   /* больше «подушек» вокруг надписей */
  min-width: 140px; 
}
.btn-primary:hover {
  background: linear-gradient(135deg, #14d0ff, #02a2ff);
}

/* Чёрные кнопки */
.btn-secondary,
.complete-btn {
  background: #413f3f;
  font-size: 1.1em;      /* текст крупнее */
  padding: 0.8em 1.2em;   /* больше «подушек» вокруг надписей */
  min-width: 140px; 
}
.btn-secondary:hover,
.complete-btn:hover {
  background: #555;
}
.complete-btn {
  display: block;
  width: 100%;
  padding: .8em 0;
  margin: 0;
  border: none;
  border-radius: 6px;
  color: #fff;
  font-size: 1.2em;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  transition: background .3s, transform .1s;
}
/* Фиксируем «оранжевый» контейнер на весь экран */
.transfer-container {
  position: fixed;      /* привязать к окну */
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  padding: 5px;        /* небольшой отступ от границ */
  box-sizing: border-box;
  overflow-y: auto;     /* вертикальный скролл при необходимости */
  overflow-x: hidden;   /* по горизонтали прокрутки не будет */
}

/* Отключаем скролл у html/body */
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  height: 100%;
}

/* 2) Блок сканов */
.scan-block {
  position: relative;
  padding: 20px;
  background: #fff8e1;
  border: 2px solid #ffd700;
  border-radius: 8px;
  text-align: center;
}

/* Общий стиль для трёх иконок в углах */
.scan-block .icon-btn {
  position: absolute;
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, #ff3c00, #ff7733);
  border: none;
  border-radius: 50%;
  color: #fff;
  font-size: 1.2em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform .2s, background .3s;
  z-index: 2;
}
.scan-block .icon-btn:hover {
  transform: scale(1.1);
  background: linear-gradient(135deg, #e04400, #ff5733);
}

/* теперь кнопки инфо и назад в пределах quantitySection */
#quantitySection .section-info {
  position: absolute;
  top: 8px;
  left: 8px;
}
#quantitySection .circle-back {
  position: absolute;
  top: 8px;
  right: 8px;
}


/* 3) Стереть сканы в самом правом углу */
.scan-block #clearScansBtn {
  top: 2px;
  right: 2px;
  width: 25px;
  height: 25px;
  font-size: 1.1em;
}

/* Popup-окно над scan-block */
.section-popup {
  position: absolute;
  top: 8px;      /* чуть ниже заголовка секции */
  left: 8px;     /* выровнять под кнопкой ❔ */
  z-index: 10;   /* поверх всего внутри scan-block */
  display: none;
  background: #fff;
  border: 1px solid #ff3c00;
  border-radius: 6px;
  padding: 10px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.section-popup .close-popup {
  position: absolute;
  top: 4px;
  right: 4px;
  border: none;
  background: none;
  font-size: 1.2em;
  cursor: pointer;
}


/* Список сканов по центру, жирный */
.scan-block .info-block {
  list-style: none;
  padding: 0;
  margin: 50px 0 0;
  font-weight: bold;
}
.source-section .info-block {
  margin-top: 10px;  /* или любое другое значение по вкусу */
}
/* Кнопка "Готово" остаётся как есть, центрируется через .done-block */
.done-block {
  text-align: center;
  margin-bottom: 10px;   /* меньше, чем было */
}
/* Блок ручного ввода количества для печати */
#printCountInput.manual-input {
  position: absolute;

  top: 60px;         /* под кнопкой печати */
  right: 10px;
  background: #fff;
  border: 2px solid #ccccccc7;
  padding: 8px;
  border-radius: 6px;
  display: none;
  z-index: 5;
}
#printCountInput.manual-input input {
  width: 80px;
  margin-right: 6px;
}
#printCountInput.manual-input .btn.cancel {
  background: #aaa;
  margin-left: 4px;
}
/* Показываем, когда нет hidden */
#printCountInput:not(.hidden) { display: flex; align-items: center; }
/* Кнопка печати в шапке — круглая, в правом верхнем углу */
#printLabelBtn {
  position: absolute;
  top: 60px;     /* под info-кнопкой, сместить вниз */
  right: 10px;    /* выровнять по правому краю точно так же, как info */
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #ff3c00, #ff7733);
  color: #fff;
  border: none;
  border-radius: 50%;
  font-size: 1.5em;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 4;
  transition: background 0.3s, transform 0.2s;
}
#printLabelBtn:hover {
  background: linear-gradient(135deg, #e04400, #ff5733);
  transform: scale(1.1);
}
#scannedList li {
  font-size: 1.2em;
  margin-bottom: 0.3em;
}
#scanCount {
  font-weight: bold;
}
.scan-container {
    max-width: 400px;
    margin: 0 auto 20px;
    padding: 0 10px;
  }

  /* Счётчик отсканированного */
  .scan-count {
    background: #f0f4f8;
    border: 1px solid #cbd6e2;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 1.3em;
    font-weight: 600;
    text-align: center;
    color: #102a43;
    margin-bottom: 12px;
  }

  /* Список циклов */
  .scan-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  /* Одиночная «карточка» коробки / текущего цикла */
  .scan-list .scan-item {
    background: #ffffff;
    border: 1px solid #d3dae6;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  /* Заголовок внутри карточки */
  .scan-item .header {
    font-size: 1.1em;
    font-weight: 600;
    color: #243b53;
    margin-bottom: 6px;
  }

  /* Список артикулов внутри карточки */
  .scan-item .items {
    font-size: 1em;
    color: #334e68;
    padding-left: 12px;
  }

  /* Особый стиль для незакрытого (текущего) цикла */
  .scan-item.current {
    background: #e6f7ff;
    border-color: #91d5ff;
  }
  /* теперь между Quantity и глобальным блоком порядка 80px */
  /* раньше было 80px */

  /* общий стиль для кнопок «Готово» и «Дальше» */
.done-block button,
.next-block button {
  font-size: 1.3rem;           /* более крупный шрифт */
  padding: 12px 24px;          /* «подушки» побольше */
  border: none;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  cursor: pointer;
  transition: transform .1s, opacity .2s;
}
/* Градиент для Done */
.btn-secondary {
  background: linear-gradient(135deg,#ff3c00,#ff7733);
  color: #fff;
}
.btn-secondary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.btn-secondary:hover:not(:disabled) {
  transform: translateY(-2px);
}
/* Градиент для Next */
.btn-primary {
  background: linear-gradient(135deg,#33a7ff,#a0e1ff);
  color: #fff;
}
.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
}
/* Контейнер кнопок внутри quantitySection */
.quantity-buttons {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-top: 12px;     /* немного пространства над кнопками */
  margin-bottom: 4px;   /* минимальный отступ под кнопками */

}


/* Единая ширина и большой текст */
.quantity-buttons button {
  flex: 0 0 200px;      /* ширина 200px вместо 160 */
  font-size: 1.4rem;    /* чуть увеличенный шрифт */
  padding: 14px 0;      /* высота кнопки больше */
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: transform .1s, opacity .2s;
}

/* Новый градиент для «Готово» */
.btn-secondary {
  background: linear-gradient(135deg, #ff3c00, #ff7733);
  color: white;
  border: none;
}
.btn-secondary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.btn-secondary:not(:disabled):hover {
  transform: translateY(-2px);
}

/* Новый градиент для «Дальше» */
.btn-primary {
  background: linear-gradient(135deg, #1E90FF, #00BFFF);
  color: white;
  border: none;
}
.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.btn-primary:not(:disabled):hover {
  transform: translateY(-2px);
}
.hidden {
  display: none !important;
}
.scan-cards .scan-info-card {
  background: #fffbe3;   /* светло-жёлтый */
  color: #d36a00;
  border: 2px solid #ffd700;
  box-shadow: 0 2px 8px #ffe39e80;
}
.scan-cards .scan-info-card .card-value {
  color: #ff9800;
  font-weight: 700;
  font-size: 1.3em;
}
.scan-cards .scan-info-card .card-label {
  color: #a67c00;
}

  </style>
</head>
<body>
  
  <div class="transfer-container">
    <input id="scanInput" type="text" autofocus
    style="position:absolute;opacity:0;width:1px;height:1px;pointer-events:none;">
    <!-- Верхняя информация и кнопка info -->
    <div class="header-info">
      <div class="static-header">
        {{ queue_label }}
      </div>
      <div class="remaining-tasks">
        Осталось задач: {{ remaining_tasks }}
      </div>
    </div>
    <button class="info-icon" id="infoIcon" title="Информация">ℹ︎</button>

        <!-- 1) Кнопка фильтра -->
        <button id="filterBtn" class="filter-btn" title="Фильтр">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M3 5h18v2H3zm4 6h10v2H7zm2 6h6v2H9z"/>
          </svg>
        </button>
        <div id="filterMenu" class="filter-menu" style="padding: 12px;">
          <a href="{{ url_for('shop_queue', mode='default', queue=queue) }}" class="filter-choice">📦 По умолчанию</a>
          <a href="{{ url_for('shop_queue', mode='articul', queue=queue) }}" class="filter-choice">🔤 По артикулу</a>
          
        </div>


    <div class="info-popup" id="infoPopup">
      <button class="close-popup" id="closeInfoBtn">×</button>
      <h3>Информация</h3>
      <p><strong>Складская задача:</strong> {{ task.task_number }}</p>
      <p><strong>Документ:</strong> {% if task.id_deliveries is defined %}{{ task.id_deliveries }}{% endif %}</p>
      <p><strong>Номер заказа:</strong> {{ task.id_orders }}</p>
    </div>
    <!-- где-то в header, рядом с Info и фильтром -->
    <button id="printLabelBtn" class="icon-btn" title="Печать этикетки">🖨</button>
    <div id="printCountInput" class="manual-input hidden">
      <input id="printQtyField" type="number" min="1" placeholder="Кол-во коробок">
      <button id="printConfirmBtn" class="btn">Готово</button>
      <button id="printCancelBtn" class="btn cancel">Отмена</button>
    </div>



    <!-- Информация о товаре -->
    <div class="product-info">
      <span>{% if task.types %}{{ task.types }}{% else %}Название товара{% endif %}</span>
      <span>({{ task.gender }} / {{ task.model }} / {{ task.color }})</span>
    </div>



    <section id="quantitySection" class="transfer-section hidden">
      <h2>Сканирование..</h2>
      <div class="info-cards scan-cards" style="margin-bottom: 15px;">
        <div class="info-card scan-info-card" id="articulCard2">
          <div class="card-label">Артикул</div>
          <div class="card-value" id="article2">{{ task.articul }}</div>
        </div>
        <div class="info-card scan-info-card" id="sizeCard2">
          <div class="card-label">Ра/Ро</div>
          <div class="card-value" id="sizeHeightValue2">{{ task.sizes }}/{{ task.heightsrus }}</div>
        </div>
        <div class="info-card scan-info-card" id="countCard2">
          <div class="card-label">Штук</div>
          <div class="card-value" id="plannedQuantityValue2">{{ task.counts }}</div>
        </div>
      </div>
      
      <button class="icon-btn section-info" data-target="popup-quantity" title="Помощь">❔</button>
      <!-- 2) Кнопка «Назад» -->
      <button class="icon-btn circle-back" id="backToSource" title="Вернуться">←</button>
    
      <!-- Кнопка очистки сканов и список -->
      <div class="scan-block">
        <button class="icon-btn" id="clearScansBtn" title="Очистить сканы">🗑</button>
        <div class="scan-container">
          <div id="scanCount" class="scan-count">
            Отсканировано: 0 из {{ task.counts }} шт.
          </div>
          <ul id="scannedList" class="scan-list"></ul>
        </div>
      </div>
      
      <!-- Popup-окно для инфо по количеству -->
      <div id="popup-quantity" class="section-popup">
        <button class="close-popup">×</button>
        <table>
          <tr><th>Артикул</th>   <td>{{ task.articul }}</td></tr>
          <tr><th>Размер</th>    <td>{{ task.sizes }}</td></tr>
          <tr><th>Рост</th>      <td>{{ task.heights }}</td></tr>
          <tr><th>Рост в см</th> <td>{{ task.heightsrus }}</td></tr>
          <tr><th>Тип</th>       <td>{{ task.types }}</td></tr>
          <tr><th>Модель</th>    <td>{{ task.model }}</td></tr>
          <tr><th>Пол</th>       <td>{{ task.gender }}</td></tr>
          <tr><th>Цвет</th>      <td>{{ task.color }}</td></tr>
        </table>
      </div>
      
      <!-- Нижний блок: кнопка Дальше -->
      <div class="quantity-buttons">
        <button id="nextBtn" class="btn-primary hidden" disabled>Дальше</button>
      </div>
    </section>
    
      
      
      
      
    </section>
    
    
    <!-- Секция "Откуда" -->
    <div class="transfer-section source-section active" id="sourceSection">
      <button class="section-info" data-target="popup-source">❔</button>
      <div id="popup-source" class="section-popup">
        <table>
          <tr><th>Артикул</th>   <td>{{ task.articul }}</td></tr>
          <tr><th>Размер</th>    <td>{{ task.sizes }}</td></tr>
          <tr><th>Рост</th>      <td>{{ task.heights }}</td></tr>
          <tr><th>Рост в см</th> <td>{{ task.heightsrus }}</td></tr>
          <tr><th>Тип</th>       <td>{{ task.types }}</td></tr>
          <tr><th>Модель</th>    <td>{{ task.model }}</td></tr>
          <tr><th>Пол</th>       <td>{{ task.gender }}</td></tr>
          <tr><th>Цвет</th>      <td>{{ task.color }}</td></tr>
        </table>
      </div>
      <h2>Откуда
        <button class="edit-btn" id="editSourceBtn" title="Редактировать">✎</button>
      </h2>
      <div class="info-block">
        <span class="label">Ячейка:</span>
        <strong id="sourceCell" class="cell-highlight">{{ task.from_cell }}</strong>
      </div>
      <div id="manualSourceInput" class="manual-input">
        <input type="text" id="sourceInputField" placeholder="Введите ячейку">
        <button id="saveSourceBtn">Сохранить</button>
        <button id="cancelSourceBtn" style="background: #aaa;">Отмена</button>
      </div>
      <div class="info-cards">
        <div class="info-card" id="articulCard">
          <div class="card-label">Артикул</div>
          <div class="card-value" id="article">{{ task.articul }}</div>
        </div>
        <div class="info-card" id="sizeCard">
          <div class="card-label">Ра/Ро</div>
          <div class="card-value" id="sizeHeightValue">{{ task.sizes }}/{{ task.heightsrus }}</div>
        </div>
        <div class="info-card" id="countCard">
          <div class="card-label">Штук</div>
          <div class="card-value" id="plannedQuantityValue">{{ task.counts }}</div>
        </div>
      </div>
      <p id="sourceStatus" class="status-text"></p>
    </div>
    
    <!-- Секция "Количество" -->
    <!-- Секция "Количество" (автоматический счётчик) -->


    
    
    
    <div class="buttons-block">
    <!-- Ряд из двух кнопок -->
    <div class="buttons-row">
      <a id="skipBtn"
         class="btn-primary"
         href="{{ url_for('shop_queue', skip=task.task_number, queue=queue) }}">
        Пропустить
      </a>
      {% if request.args.get('mode') %}
        <a class="btn-secondary"
           href="{{ url_for('queue_turn',
                           turn=queue) }}">
          Вернуться
        </a>
      {% else %}
        <a class="btn-secondary"
           href="{{ url_for('queue_turn', turn=queue) }}">
          Вернуться
        </a>
      {% endif %}
    </div>
  
    <!-- Под ними — одна большая кнопка -->
    <form id="completeForm" method="post" action="{{ url_for('split_order') }}">
      <input type="hidden" name="order_id"  value="{{ task.id_orders }}">
      <input type="hidden" name="turn"      value="{{ queue }}">
      <input type="hidden" name="mode"      value="{{ request.args.get('mode','') }}">
      <button type="submit" id="completeBtn" class="complete-btn">
        Завершить работу
      </button>
    </form>
    
  </div>
  <div id="remainingTasks" data-tasks="{{ remaining_tasks }}"></div>
  
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Константы и секции ---
      const TASK_ID         = parseInt("{{ task.task_number }}", 10);
      const sourceSection   = document.getElementById('sourceSection');
      const quantitySection = document.getElementById('quantitySection');
      const scanInput       = document.getElementById('scanInput');
      const scanBlock     = document.querySelector('.scan-block');

      const scannedList     = document.getElementById('scannedList');
      const backToSourceBtn = document.getElementById('backToSource');
      const nextBtn         = document.getElementById('nextBtn');
      const plannedQuantity = parseInt(document.getElementById('plannedQuantityValue2').textContent, 10);

      scanInput.focus();
      scanInput.addEventListener('blur', e => {
        // куда ушёл фокус?
        const to = e.relatedTarget;
        // если это какая-то кнопка/ссылка или поле ввода печати — НЕ возвращаем фокус
        if (
            to &&
            (
            to.tagName === 'BUTTON' ||
            to.tagName === 'A' ||
            to === printField ||
            to.closest('.manual-input')  // любое поле внутри ручного ввода
            )
        ) {
            return;
        }
        // во всех остальных случаях, только если ручной ввод закрыт
        if (printInputDiv.classList.contains('hidden')) {
            scanInput.focus();
        }
        });
    
      let step = 'source';
      let currentItems = [];
      let cycles       = [];

      window.onBarcodeScanned = function(scannedCode) {
        const code = scannedCode.trim();
        scanInput.value = code;
        const evt = new KeyboardEvent('keydown', { key: 'Enter', bubbles: true });
        document.dispatchEvent(evt);
      };
    
      function showSection(name) {
        sourceSection.classList.toggle('active',  name === 'source');
        sourceSection.classList.toggle('hidden',  name !== 'source');
        quantitySection.classList.toggle('active', name === 'quantity');
        quantitySection.classList.toggle('hidden', name !== 'quantity');
        step = name;
        if (name === 'quantity') quantitySection.scrollIntoView({ behavior: 'smooth' });
        scanInput?.focus();
      }
    

      // --- Info-popup ℹ︎ ---
      const infoIcon     = document.getElementById('infoIcon');
      const infoPopup    = document.getElementById('infoPopup');
      const closeInfoBtn = document.getElementById('closeInfoBtn');
      infoIcon.addEventListener('click', e => {
        e.stopPropagation();
        infoPopup.style.display = infoPopup.style.display === 'block' ? 'none' : 'block';
      });
      closeInfoBtn?.addEventListener('click', () => infoPopup.style.display = 'none');
      document.addEventListener('click', () => infoPopup.style.display = 'none');
    
      // --- Фильтр задач ---
      const filterBtn  = document.getElementById('filterBtn');
      const filterMenu = document.getElementById('filterMenu');
      filterBtn.addEventListener('click', e => {
        e.stopPropagation();
        filterMenu.style.display = filterMenu.style.display === 'block' ? 'none' : 'block';
      });
      document.addEventListener('click', e => {
        if (!filterBtn.contains(e.target) && !filterMenu.contains(e.target))
          filterMenu.style.display = 'none';
      });
    
      // --- Section-info (❔) для подсказок ---
      document.querySelectorAll('.section-info').forEach(btn => {
        const popup = document.getElementById(btn.dataset.target);
        btn.addEventListener('click', e => {
          e.stopPropagation();
          popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        });
      });
      document.addEventListener('click', () => {
        document.querySelectorAll('.section-popup').forEach(p => p.style.display = 'none');
      });
      // --- Печать этикетки: открыть ввод количества ---
    const printBtn      = document.getElementById('printLabelBtn');
    const printInputDiv = document.getElementById('printCountInput');
    const printField    = document.getElementById('printQtyField');
    const printOkBtn    = document.getElementById('printConfirmBtn');
    const printCancel   = document.getElementById('printCancelBtn');



    printBtn.addEventListener('click', e => {
    e.stopPropagation();
    printInputDiv.classList.toggle('hidden');
    if (!printInputDiv.classList.contains('hidden')) {
        // очищаем и даём фокус полю «Кол-во коробок»
        printField.value = '';
        setTimeout(() => printField.focus(), 0);
    }
    });

    // Отмена ввода
    printCancel.addEventListener('click', () => {
      printInputDiv.classList.add('hidden');
    });

    // Подтвердить и печать
    printOkBtn.addEventListener('click', async () => {
      const cnt = parseInt(printField.value, 10);
      if (!cnt || cnt < 1) {
        Swal.fire({
          icon: 'error',
          title: 'Укажите корректное количество!',
          toast: true, position: 'top-end',
          timer: 2000, showConfirmButton: false
        });
        return;
      }
      printInputDiv.classList.add('hidden');
      try {
        const res = await fetch('/shop_queue/print_box', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({count: cnt})
        });
        const js  = await res.json();
        Swal.fire({
          icon: js.status==='success'?'success':'error',
          title: js.status==='success'?'Печать запущена':('Ошибка: '+(js.error||js.message)),
          toast: true, position: 'top-end',
          timer: 1500, showConfirmButton: false
        });
      } catch {
        Swal.fire({
          icon: 'error',
          title: 'Ошибка связи',
          toast: true, position: 'top-end',
          timer: 2000, showConfirmButton: false
        });
      }
    });
      document.querySelectorAll('.section-popup .close-popup').forEach(x => {
        x.addEventListener('click', e => {
          const popup = x.closest('.section-popup');
          popup.style.display = 'none';
        });
      });
    
      // 3) Клик вне любого попапа – прячем всё
      document.addEventListener('click', () => {
        document.querySelectorAll('.section-popup').forEach(p => {
          p.style.display = 'none';
        });
      });
    
      // --- Ручной ввод «Откуда» ---
      const editSourceBtn     = document.getElementById('editSourceBtn');
      const manualSourceInput = document.getElementById('manualSourceInput');
      const sourceInputField  = document.getElementById('sourceInputField');
      const saveSourceBtn     = document.getElementById('saveSourceBtn');
      const cancelSourceBtn   = document.getElementById('cancelSourceBtn');
      const sourceStatusEl    = document.getElementById('sourceStatus');
      const sourceCellElem    = document.getElementById('sourceCell');
    
      editSourceBtn.addEventListener('click', e => {
        e.stopPropagation();
        manualSourceInput.style.display = manualSourceInput.style.display === 'block' ? 'none' : 'block';
        if (manualSourceInput.style.display === 'block') {
          sourceInputField.value = '';
          sourceInputField.focus();
          editSourceBtn.classList.add('active');
        } else {
          editSourceBtn.classList.remove('active');
        }
      });
      cancelSourceBtn.addEventListener('click', () => {
        manualSourceInput.style.display = 'none';
        sourceStatusEl.textContent = '';
        editSourceBtn.classList.remove('active');
      });
      saveSourceBtn.addEventListener('click', async () => {
        const cell = sourceInputField.value.trim();
        if (!cell) {
          sourceStatusEl.textContent = 'Введите ячейку!';
          return;
        }
        const res = await fetch('/shop_queue/validate_source', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({cell_code: cell, task_id: TASK_ID})
        });
        const js = await res.json();
        if (js.status === 'success') {
          sourceCellElem.textContent = cell;
          sourceCellElem.classList.add('confirmed-cell');
          sourceSection.classList.add('confirmed');
          manualSourceInput.style.display = 'none';
          sourceStatusEl.textContent = '';
          editSourceBtn.classList.remove('active');
          showSection('quantity');
        } else {
          sourceStatusEl.textContent = js.message;
        }
      });
    
      // --- Сканирование в секции «Количество» ---

      const clearScansBtn = document.getElementById('clearScansBtn');
      const printLabelBtn = document.getElementById('printLabelBtn');

    
      clearScansBtn.onclick = async () => {
        currentItems = [];
        cycles = [];
        renderCycles();
        scanBlock.classList.remove('grayed');
        scanInput.disabled = false;

        // Сброс на сервере!
        await fetch('/shop_queue/clear_scans', { method: 'POST' });

        nextBtn.classList.add('hidden');
        nextBtn.disabled = true;
      };

      
      

      // возврат к блоку «Откуда»
    document.getElementById('backToSource').addEventListener('click', () => {
      showSection('source');
    });


    window.addEventListener('beforeunload', () => {
      currentItems = [];
      cycles       = [];
      renderCycles();
      nextBtn.disabled = true;
      scanInput.disabled = false;
      
      quantitySection.classList.remove('grayed');
    });



    

    
    document.addEventListener('keydown', async e => {
    if (e.key !== 'Enter') return;
    e.preventDefault();
    const code = (scanInput.value || '').trim() || prompt('Сканируйте код:');
    scanInput.value = '';
    if (!code) return;

    // 1) Шаг "Откуда"
    if (step === 'source') {
      const res = await fetch('/shop_queue/validate_source', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cell_code: code, task_id: TASK_ID })
      });
      const js = await res.json();
      if (js.status === 'success') {
        if (window.AndroidAudio && window.AndroidAudio.playSuccess) window.AndroidAudio.playSuccess();
        sourceSection.classList.add('confirmed');
        document.getElementById('sourceCell').textContent = code;
        showSection('quantity');
        await fetch('/shop_queue/clear_scans', { method: 'POST' });
        currentItems = [];
        cycles       = [];
        renderCycles();
      } else {
        if (window.AndroidAudio && window.AndroidAudio.playError) window.AndroidAudio.playError();
        
        Swal.fire({ icon: 'error', title: js.message, toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
      }
      return;
    }

    // 2) Шаг "Количество"
    if (step === 'quantity') {
      const res2 = await fetch('/shop_queue/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code, step: 'quantity' })
      });
      const js2 = await res2.json();
      if (js2.status !== 'success') {
        if (window.AndroidAudio && window.AndroidAudio.playError) window.AndroidAudio.playError();
        Swal.fire({ icon: 'error', title: js2.message, toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
        return;
      } else {
        if (window.AndroidAudio && window.AndroidAudio.playSuccess) window.AndroidAudio.playSuccess();
      }
      if (js2.type === 'item') {
        currentItems.push(js2.record);
      } else if (js2.type === 'box') {
        if (currentItems.length === 0) {
          if (window.AndroidAudio && window.AndroidAudio.playError) window.AndroidAudio.playError();
          Swal.fire({ icon: 'warning', title: 'Сначала отсканируйте товар', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
          return;
        }
        cycles.push({ items: currentItems.slice(), box: js2.record });
        currentItems = [];
      }
      renderCycles();
      return;
    }
  }); 

  // Функция отрисовки списка циклов (товары + коробки)
  function renderCycles() {
    // 1) Подсчитываем общее количество
    const scanned = cycles.reduce((sum, c) => sum + c.items.length, 0)
                  + currentItems.length;
    const total = plannedQuantity; // <= вот это ключ!
  
    document.getElementById('scanCount').textContent =
      `Отсканировано: ${scanned} из ${total} шт.`;
  
    const closed = cycles.map(c => `
      <li class="scan-item">
        <div class="header">Коробка ${c.box.num_case}</div>
        <div class="items">${c.items.map(it => it.articul).join(', ')}</div>
      </li>
    `).join('');
  
    // 3) Генерируем HTML для текущего незавершённого цикла
    const current = currentItems.length
      ? `
      <li class="scan-item current">
        <div class="header">Сканируйте товар</div>
        <div class="items">${currentItems.map(it => it.articul).join(', ')}</div>
      </li>
      `
      : '';
  
    // 4) Вставляем всё в список
    document.getElementById('scannedList').innerHTML = closed + current;
  
    updateNextButton();
  }
  



  // Завершить упаковочные циклы и показать кнопку "Далее"

  
  

  // Отправка результатов на сервер
  nextBtn.addEventListener('click', async () => {
    // Считаем количество отсканированных товаров
    let scanned = 0;
    for (const c of cycles) scanned += c.items.length;
    const required = plannedQuantity; // task.counts
  
    // Проверяем — если не все штуки, спрашиваем подтверждение
    if (scanned < required) {
      const res = await Swal.fire({
        icon: 'warning',
        title: `Вы уверены? Осталось неотсканировано ${required - scanned} из ${required} штук.`,
        showCancelButton: true,
        confirmButtonText: 'Да, продолжить',
        cancelButtonText: 'Отмена'
      });
      if (!res.isConfirmed) {
        return;
      }
    }
  
    // Здесь — твоя старая логика отправки:
    try {
      const res  = await fetch('/shop_queue/update_task', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ cycles })
      });
      const js   = await res.json();
  
      if (res.ok && js.status === 'success') {
        // успех → переход к следующему заданию
        window.location.reload();
      } else {
        // неуспех → выводим ошибку как тост
        Swal.fire({
          icon: 'error',
          title: 'Ошибка',
          text: js.message || 'Не удалось перейти к следующему заданию',
          toast: true,
          position: 'top-end',
          timer: 2000,
          showConfirmButton: false
        });
      }
    } catch (e) {
      // сеть упала или другой сбой
      Swal.fire({
        icon: 'error',
        title: 'Ошибка связи',
        text: 'Не удалось соединиться с сервером',
        toast: true,
        position: 'top-end',
        timer: 2000,
        showConfirmButton: false
      });
    }
  });
  
  
 
      // --- Начальный фокус ---
      scanInput?.focus();
      
      
    });
    document.addEventListener('DOMContentLoaded', () => {
      const form      = document.getElementById('completeForm');
      const remaining = parseInt(
      document.getElementById('remainingTasks').dataset.tasks,
      10
    ) || 0;  // передаётся из Flask
  
      form.addEventListener('submit', function(e) {
        e.preventDefault();  // отмени отправку пока не подтвердили
  
        Swal.fire({
          title: 'Подтверждение',
          text:  `Осталось ${remaining} складских задач. Вы уверены, что хотите завершить работу?`,
          icon:  'warning',
          showCancelButton:  true,
          confirmButtonText: 'Да, завершить',
          cancelButtonText:  'Нет'
        }).then(result => {
          if (result.isConfirmed) {
            form.submit();  // только после подтверждения
          }
        });
      });
    });
    function updateNextButton() {
      nextBtn.classList.remove('hidden');
      nextBtn.disabled = false;
    }

    </script>
    
    
    
</body>
</html>