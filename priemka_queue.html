<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–∏—ë–º–∫–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º SweetAlert2 –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"> -->


  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
    html, body {
      font-family: 'Montserrat', sans-serif;
    }
    html, body {
    overflow-x: hidden;
    margin: 0;
    padding: 0;
   }
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }
    .transfer-container {
      width: 90%;
      max-width: 600px;
      background: #fff;
      border: 1px solid #ff3c00;
      border-radius: 0px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
      position: relative;
      padding: 20px 20px 60px 20px;
    }
    /* Info-–∫–Ω–æ–ø–∫–∞ –≤ —Å–∞–º–æ–º –≤–µ—Ä—Ö–Ω–µ–º –ø—Ä–∞–≤–æ–º —É–≥–ª—É */
    .info-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      background: linear-gradient(135deg, #ff3c00, #ff7733);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.5em;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.3s;
      z-index: 3;
    }
    .info-icon:hover {
      background: linear-gradient(135deg, #e04400, #ff5733);
    }
    /* Popup —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π */
    .info-popup {
      display: none;
      position: absolute;
      top: 60px;
      right: 10px;
      background: linear-gradient(135deg, #fff, #f0f0f0);
      border: 2px solid #ff3c00;
      border-radius: 8px;
      padding: 10px;
      width: 260px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 3;
    }
    .info-popup h3 {
      margin: 0 0 5px;
      font-size: 1.2em;
      color: #ff3c00;
    }
    .info-popup p {
      margin: 3px 0;
      font-size: 1em;
      color: #333;
    }
    .info-popup .close-popup {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      color: #ff3c00;
    }
    .header-info {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #ccc;
    }

    .static-header {
      font-size: 1.5em;
      color: #ff3c00;
      line-height: 1.1;  /* —á—É—Ç—å –ø–ª–æ—Ç–Ω–µ–µ —Å—Ç—Ä–æ–∫–∏ */
      text-align: center;
    }

    .warehouse-task-number,
    .doc-info,
    .remaining-tasks {
      font-size: 1.2em;
      margin: 3px 0;
      color: #333;
      font-weight: 600;
    }
    /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ */
    .product-info {
      text-align: center;
      font-size: 1.2em;
      color: #555;
      margin-bottom: 10px;
    }
    .product-info span {
      display: block;
    }
    /* –°–µ–∫—Ü–∏–∏ */
    .transfer-section {
      margin-bottom: 15px;
      padding: 20px;
      background: linear-gradient(135deg, #fafafa, #f0f0f0);
      border: 2px solid #ccc;
      border-radius: 8px;
      transition: border-color 0.3s, background 0.3s, color 0.3s;
      position: relative;
    }
    .transfer-section.active {
      border-color: #FFD700;
      background: linear-gradient(135deg, #fff8e1, #fff3cd);
      color: #444;
    }
    .transfer-section.confirmed {
      color: #333 !important;
      border-color: #28a745;
      background: linear-gradient(135deg, #eaffea, #d4f7d4);
      color: #fff;
    }
    .transfer-section h2 {
      margin: 0 0 10px;
      font-size: 1.4em;
      color: inherit;
      text-align: center;
      border-bottom: 2px solid #ccc;
      padding-bottom: 5px;
    }

    /* –†—É—á–Ω–æ–π –≤–≤–æ–¥ */
    .manual-input {
      display: none;
      margin-top: 10px;
      text-align: center;
    }
    .manual-input input {
      padding: 8px;
      font-size: 1em;
      border: 2px solid #ff3c00;
      border-radius: 4px;
      width: 60%;
      margin-bottom: 5px;
    }
    .manual-input button {
      padding: 8px 15px;
      font-size: 1em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 5px;
      background: linear-gradient(135deg, #FF3366, #FF7733);
      color: #fff;
      transition: background 0.3s;
    }
    .manual-input button:hover {
      background: linear-gradient(135deg, #FF2255, #FF6633);
    }
    /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ */
    .info-block {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1em;
      font-weight: bold;
      color: inherit;
    }
    .cell-highlight {
      display: block;
      font-size: 2em;
      font-weight: bold;
      padding: 10px 20px;
      background-color: #ff3c00;
      color: #fff;
      border-radius: 8px;
      margin: 5px auto;
      transition: background-color 0.3s;
    }
    .confirmed-cell {
      background-color: #28a745 !important;
    }
    .status-text {
      text-align: center;
      font-size: 1.1em;
      color: #888;
      margin-top: 5px;
    }
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–ê—Ä—Ç–∏–∫—É–ª, –†–∞/–†–æ, –®—Ç—É–∫) */
    .info-cards {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .info-card {
      background: #ff3c00;
      color: #fff;
      border-radius: 8px;
      width: 100px;
      height: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
      transition: background 0.3s;
    }
    .info-card:hover {
      background: #ff5722;
    }
    .card-label {
      font-size: 0.7em;
      opacity: 0.9;
    }
    .card-value {
      font-size: 1.1em;
      font-weight: bold;
      margin-top: 3px;
    }
    /* –ë–ª–æ–∫ "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" */
    .quantity-block {
      text-align: center;
      margin-top: 15px;
      position: relative;
    }
    .quantity-block input[type="number"] {
      width: 100px;
      padding: 10px;
      font-size: 1.3em;
      border: 2px solid #ccc;
      border-radius: 6px;
      margin-right: 10px;
      transition: border-color 0.3s;
    }
    .quantity-block input[type="number"]:focus {
      border-color: #ff3c00;
      outline: none;
    }
    .quantity-block .btn {
      padding: 10px 20px;
      font-size: 1.3em;
      background: linear-gradient(135deg, #FF3366, #FF7733);
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: background 0.3s, transform 0.2s;
    }
    .quantity-block .btn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .quantity-block .btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #FF2255, #FF6633);
      transform: translateY(-2px);
    }
    .back-btn-qty {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6a00, #ee0979);
      color: #fff;
      font-size: 1.8em;
      cursor: pointer;
      outline: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background 0.3s, transform 0.2s;
    }
    .back-btn-qty:hover {
      background: linear-gradient(135deg, #e05500, #d80a70);
      transform: scale(1.05);
    }
    /* –ù–∏–∂–Ω–∏–π –±–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ */
    .bottom-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      gap: 20px;
    }
    .back-btn, .skip-btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 1.1em;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.3s;
      flex: 1;
      text-align: center;
    }
    .back-btn {
      background: #333;
      color: #fff;
    }
    .back-btn:hover {
      background: #555;
    }
    .skip-btn {
      background: #007bff;
      color: #fff;
      border: none;
    }
    .skip-btn:hover {
      background: #0056b3;
    }

    /* 1) –û–±—â–∏–π —Å—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–π */
.transfer-section .section-info,
.transfer-section .edit-btn {
  position: absolute;
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #ff3c00, #ff7733);
  color: #fff;
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2em;
  cursor: pointer;
  transition: transform .2s, background .2s;
  z-index: 10;
}
/* info —Å–ª–µ–≤–∞, edit —Å–ø—Ä–∞–≤–∞ */
.transfer-section .section-info {
  top: 8px;
  left: 8px;
}
.transfer-section .edit-btn {
  top: 8px;
  right: 8px;
}
/* hover‚Äë—ç—Ñ—Ñ–µ–∫—Ç */
.transfer-section .section-info:hover,
.transfer-section .edit-btn:hover {
  transform: scale(1.1);
  background: linear-gradient(135deg, #e04400, #ff5733);
}

/* 2) –ö—Ä–∞—Å–∏–≤—ã–π, –ª—ë–≥–∫–∏–π popup‚Äë–±–ª–æ–∫ */
.section-popup {
  display: none;
  position: absolute;
  border: 1.5px solid #ff3c00;
  top: 42px;        /* –ø–æ–¥ 32px‚Äë–∫–Ω–æ–ø–∫–æ–π + 8px –æ—Ç—Å—Ç—É–ø */
  left: 8px;        /* —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ª–µ–≤—ã–º –æ—Ç—Å—Ç—É–ø–æ–º –∫–Ω–æ–ø–∫–∏ ‚ùî */
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
  padding: 12px;
  z-index: 20;
  min-width: 200px;
}

/* –¢–∞–±–ª–∏—Ü–∞ –≤–Ω—É—Ç—Ä–∏ pop‚Äëup, –∑–µ–±—Ä–∞‚Äë—à–∞–±–ª–æ–Ω, —á–∏—Ç–∞–µ–º–æ—Å—Ç—å */
.section-popup table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9em;
}
.section-popup th,
.section-popup td {
  padding: 8px 10px;
  text-align: left;
}
.section-popup th {
  background: #ff3c00;
  color: #fff;
  font-weight: 600;
  border-bottom: 2px solid #e0e0e0;
}
.section-popup tr:nth-child(odd) {
  background: #f9f9f9;
}
.section-popup tr:nth-child(even) {
  background: #fff;
}
.filter-btn {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 42px;
  height: 42px;
  background: linear-gradient(135deg,#ff3c00,#ff7733);
  border: none;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  z-index: 10;
}
.filter-btn svg {
  width: 22px;
  height: 22px;
  fill: #fff;
}
.filter-menu {
  display: none;
  position: absolute;
  top: 60px;
  left: 10px;
  background: #fff;
  border: 2px solid #ff3c00;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,.2);
  z-index: 99;
  padding: 8px 0;
  min-width: 240px;
}
.filter-option {
  padding: 12px 16px;
  font-size: 1rem;
  color: #333;
  cursor: pointer;
  transition: background 0.2s ease;
}
.filter-option:hover {
  background: #ffe0d3;
}
.filter-choice {
    display: block;
    background: linear-gradient(135deg, #ff3c00, #ff7733);
    color: #fff;
    font-weight: 600;
    text-align: center;
    text-decoration: none;
    border-radius: 10px;
    padding: 12px;
    margin: 6px 0;
    transition: background 0.3s, transform 0.2s;
  }
  .filter-choice:hover {
    background: linear-gradient(135deg, #e04400, #ff5733);
    transform: scale(1.05);
  }
  
  .circle-back {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(135deg, #ff3c00, #ff7733);
  color: #fff;
  font-size: 1.2em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}


/* –ö–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –±–ª–æ–∫–∞ */
.hidden {
  display: none;
}

/* –ö–ª–∞—Å—Å –¥–ª—è ¬´–∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è¬ª –±–ª–æ–∫–∞ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ */
/* –ì–∞—Å–∏–º —Ç–æ–ª—å–∫–æ –±–ª–æ–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
.scan-block.grayed {
  opacity: 0.5;
  pointer-events: none;
}
/* –ù–æ –∫–Ω–æ–ø–∫—É "–û—á–∏—Å—Ç–∏—Ç—å" –æ—Å—Ç–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–π */
.scan-block.grayed #clearScansBtn {
  opacity: 1 !important;
  pointer-events: auto !important;
}

/* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∏ –ø–æ–¥—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ */
.done-block,
.next-block {
  text-align: center;
  margin-bottom: 10px;
}
.next-block {
  margin-top: 10px;
}
.next-block .btn-primary {
  min-width: 160px;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ—Ö —Ç—Ä—ë—Ö –∫–Ω–æ–ø–æ–∫ */
.buttons-block {
  width: 100%;
  max-width: 600px;
  margin: 0 auto 2em;
  box-sizing: border-box;
}

/* –ü–µ—Ä–≤—ã–π —Ä—è–¥: –¥–≤–µ –∫–Ω–æ–ø–∫–∏ —Ä—è–¥–æ–º */
.buttons-row {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}
.buttons-row a {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  padding: .8em 0;
  border-radius: 6px;
  color: #fff;
  font-size: 1.2em;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  transition: background .3s, transform .1s;
}

/* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
.btn-primary {
  background: linear-gradient(135deg, #33a7ff, #a0e1ff);
  font-size: 1.1em;      /* —Ç–µ–∫—Å—Ç –∫—Ä—É–ø–Ω–µ–µ */
  padding: 0.8em 1.2em;   /* –±–æ–ª—å—à–µ ¬´–ø–æ–¥—É—à–µ–∫¬ª –≤–æ–∫—Ä—É–≥ –Ω–∞–¥–ø–∏—Å–µ–π */
  min-width: 140px; 
}
.btn-primary:hover {
  background: linear-gradient(135deg, #14d0ff, #02a2ff);
}

/* –ß—ë—Ä–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
.btn-secondary,
.complete-btn {
  background: #413f3f;
  font-size: 1.1em;      /* —Ç–µ–∫—Å—Ç –∫—Ä—É–ø–Ω–µ–µ */
  padding: 0.8em 1.2em;   /* –±–æ–ª—å—à–µ ¬´–ø–æ–¥—É—à–µ–∫¬ª –≤–æ–∫—Ä—É–≥ –Ω–∞–¥–ø–∏—Å–µ–π */
  min-width: 140px; 
}
.btn-secondary:hover,
.complete-btn:hover {
  background: #555;
}
.complete-btn {
  display: block;
  width: 100%;
  padding: .8em 0;
  margin: 0;
  border: none;
  border-radius: 6px;
  color: #fff;
  font-size: 1.2em;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  transition: background .3s, transform .1s;
}
/* –§–∏–∫—Å–∏—Ä—É–µ–º ¬´–æ—Ä–∞–Ω–∂–µ–≤—ã–π¬ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
.transfer-container {
  position: fixed;      /* –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫ –æ–∫–Ω—É */
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  padding: 5px;        /* –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –æ—Ç –≥—Ä–∞–Ω–∏—Ü */
  box-sizing: border-box;
  overflow-y: auto;     /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
  overflow-x: hidden;   /* –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –Ω–µ –±—É–¥–µ—Ç */
}

/* –û—Ç–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª —É html/body */
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  height: 100%;
}

/* 2) –ë–ª–æ–∫ —Å–∫–∞–Ω–æ–≤ */
.scan-block {
  position: relative;
  padding: 20px;
  background: #fff8e1;
  border: 2px solid #ffd700;
  border-radius: 8px;
  text-align: center;
}

/* –û–±—â–∏–π —Å—Ç–∏–ª—å –¥–ª—è —Ç—Ä—ë—Ö –∏–∫–æ–Ω–æ–∫ –≤ —É–≥–ª–∞—Ö */
.scan-block .icon-btn {
  position: absolute;
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, #ff3c00, #ff7733);
  border: none;
  border-radius: 50%;
  color: #fff;
  font-size: 1.2em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform .2s, background .3s;
  z-index: 2;
}
.scan-block .icon-btn:hover {
  transform: scale(1.1);
  background: linear-gradient(135deg, #e04400, #ff5733);
}

/* —Ç–µ–ø–µ—Ä—å –∫–Ω–æ–ø–∫–∏ –∏–Ω—Ñ–æ –∏ –Ω–∞–∑–∞–¥ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö quantitySection */
#quantitySection .section-info {
  position: absolute;
  top: 8px;
  left: 8px;
}
#quantitySection .circle-back {
  position: absolute;
  top: 8px;
  right: 8px;
}


/* 3) –°—Ç–µ—Ä–µ—Ç—å —Å–∫–∞–Ω—ã –≤ —Å–∞–º–æ–º –ø—Ä–∞–≤–æ–º —É–≥–ª—É */
.scan-block #clearScansBtn {
  top: 2px;
  right: 2px;
  width: 25px;
  height: 25px;
  font-size: 1.1em;
}

/* Popup-–æ–∫–Ω–æ –Ω–∞–¥ scan-block */
.section-popup {
  position: absolute;
  top: 8px;      /* —á—É—Ç—å –Ω–∏–∂–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å–µ–∫—Ü–∏–∏ */
  left: 8px;     /* –≤—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π ‚ùî */
  z-index: 10;   /* –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ –≤–Ω—É—Ç—Ä–∏ scan-block */
  display: none;
  background: #fff;
  border: 1px solid #ff3c00;
  border-radius: 6px;
  padding: 10px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.section-popup .close-popup {
  position: absolute;
  top: 4px;
  right: 4px;
  border: none;
  background: none;
  font-size: 1.2em;
  cursor: pointer;
}


/* –°–ø–∏—Å–æ–∫ —Å–∫–∞–Ω–æ–≤ –ø–æ —Ü–µ–Ω—Ç—Ä—É, –∂–∏—Ä–Ω—ã–π */
.scan-block .info-block {
  list-style: none;
  padding: 0;
  margin: 50px 0 0;
  font-weight: bold;
}
.source-section .info-block {
  margin-top: 10px;  /* –∏–ª–∏ –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –≤–∫—É—Å—É */
}
/* –ö–Ω–æ–ø–∫–∞ "–ì–æ—Ç–æ–≤–æ" –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å, —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ .done-block */
.done-block {
  text-align: center;
  margin-bottom: 10px;   /* –º–µ–Ω—å—à–µ, —á–µ–º –±—ã–ª–æ */
}
/* –ë–ª–æ–∫ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏ */
#printCountInput.manual-input {
  position: absolute;

  top: 60px;         /* –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π –ø–µ—á–∞—Ç–∏ */
  right: 10px;
  background: #fff;
  border: 2px solid #ccccccc7;
  padding: 8px;
  border-radius: 6px;
  display: none;
  z-index: 5;
}
#printCountInput.manual-input input {
  width: 80px;
  margin-right: 6px;
}
#printCountInput.manual-input .btn.cancel {
  background: #aaa;
  margin-left: 4px;
}
/* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –∫–æ–≥–¥–∞ –Ω–µ—Ç hidden */
#printCountInput:not(.hidden) { display: flex; align-items: center; }
/* –ö–Ω–æ–ø–∫–∞ –ø–µ—á–∞—Ç–∏ –≤ —à–∞–ø–∫–µ ‚Äî –∫—Ä—É–≥–ª–∞—è, –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É */
#printLabelBtn {
  position: absolute;
  top: 60px;     /* –ø–æ–¥ info-–∫–Ω–æ–ø–∫–æ–π, —Å–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑ */
  right: 10px;    /* –≤—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é —Ç–æ—á–Ω–æ —Ç–∞–∫ –∂–µ, –∫–∞–∫ info */
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #ff3c00, #ff7733);
  color: #fff;
  border: none;
  border-radius: 50%;
  font-size: 1.5em;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 4;
  transition: background 0.3s, transform 0.2s;
}
#printLabelBtn:hover {
  background: linear-gradient(135deg, #e04400, #ff5733);
  transform: scale(1.1);
}
#scannedList li {
  font-size: 1.2em;
  margin-bottom: 0.3em;
}
#scanCount {
  font-weight: bold;
}
.scan-container {
    max-width: 400px;
    margin: 0 auto 20px;
    padding: 0 10px;
  }

  /* –°—á—ë—Ç—á–∏–∫ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ */
  .scan-count {
    background: #f0f4f8;
    border: 1px solid #cbd6e2;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 1.3em;
    font-weight: 600;
    text-align: center;
    color: #102a43;
    margin-bottom: 12px;
  }

  /* –°–ø–∏—Å–æ–∫ —Ü–∏–∫–ª–æ–≤ */
  .scan-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  /* –û–¥–∏–Ω–æ—á–Ω–∞—è ¬´–∫–∞—Ä—Ç–æ—á–∫–∞¬ª –∫–æ—Ä–æ–±–∫–∏ / —Ç–µ–∫—É—â–µ–≥–æ —Ü–∏–∫–ª–∞ */
  .scan-list .scan-item {
    background: #ffffff;
    border: 1px solid #d3dae6;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
  .scan-item .header {
    font-size: 1.1em;
    font-weight: 600;
    color: #243b53;
    margin-bottom: 6px;
  }

  /* –°–ø–∏—Å–æ–∫ –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
  .scan-item .items {
    font-size: 1em;
    color: #334e68;
    padding-left: 12px;
  }

  /* –û—Å–æ–±—ã–π —Å—Ç–∏–ª—å –¥–ª—è –Ω–µ–∑–∞–∫—Ä—ã—Ç–æ–≥–æ (—Ç–µ–∫—É—â–µ–≥–æ) —Ü–∏–∫–ª–∞ */
  .scan-item.current {
    background: #e6f7ff;
    border-color: #91d5ff;
  }
  /* —Ç–µ–ø–µ—Ä—å –º–µ–∂–¥—É Quantity –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º –±–ª–æ–∫–æ–º –ø–æ—Ä—è–¥–∫–∞ 80px */
  /* —Ä–∞–Ω—å—à–µ –±—ã–ª–æ 80px */

  /* –æ–±—â–∏–π —Å—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ ¬´–ì–æ—Ç–æ–≤–æ¬ª –∏ ¬´–î–∞–ª—å—à–µ¬ª */
.done-block button,
.next-block button {
  font-size: 1.3rem;           /* –±–æ–ª–µ–µ –∫—Ä—É–ø–Ω—ã–π —à—Ä–∏—Ñ—Ç */
  padding: 12px 24px;          /* ¬´–ø–æ–¥—É—à–∫–∏¬ª –ø–æ–±–æ–ª—å—à–µ */
  border: none;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  cursor: pointer;
  transition: transform .1s, opacity .2s;
}
/* –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è Done */
.btn-secondary {
  background: linear-gradient(135deg,#ff3c00,#ff7733);
  color: #fff;
}
.btn-secondary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.btn-secondary:hover:not(:disabled) {
  transform: translateY(-2px);
}
/* –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è Next */
.btn-primary {
  background: linear-gradient(135deg,#33a7ff,#a0e1ff);
  color: #fff;
}
.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
}
/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ quantitySection */
.quantity-buttons {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-top: 12px;     /* –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –Ω–∞–¥ –∫–Ω–æ–ø–∫–∞–º–∏ */
  margin-bottom: 4px;   /* –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–æ–¥ –∫–Ω–æ–ø–∫–∞–º–∏ */

}


/* –ï–¥–∏–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∏ –±–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç */
.quantity-buttons button {
  flex: 0 0 200px;      /* —à–∏—Ä–∏–Ω–∞ 200px –≤–º–µ—Å—Ç–æ 160 */
  font-size: 1.4rem;    /* —á—É—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç */
  padding: 14px 0;      /* –≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏ –±–æ–ª—å—à–µ */
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: transform .1s, opacity .2s;
}

/* –ù–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è ¬´–ì–æ—Ç–æ–≤–æ¬ª */
.btn-secondary {
  background: linear-gradient(135deg, #ff3c00, #ff7733);
  color: white;
  border: none;
}
.btn-secondary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.btn-secondary:not(:disabled):hover {
  transform: translateY(-2px);
}

/* –ù–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è ¬´–î–∞–ª—å—à–µ¬ª */
.btn-primary {
  background: linear-gradient(135deg, #1E90FF, #00BFFF);
  color: white;
  border: none;
}
.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.btn-primary:not(:disabled):hover {
  transform: translateY(-2px);
}
.hidden {
  display: none !important;
}
.scan-cards .scan-info-card {
  background: #fffbe3;   /* —Å–≤–µ—Ç–ª–æ-–∂—ë–ª—Ç—ã–π */
  color: #d36a00;
  border: 2px solid #ffd700;
  box-shadow: 0 2px 8px #ffe39e80;
}
.scan-cards .scan-info-card .card-value {
  color: #ff9800;
  font-weight: 700;
  font-size: 1.3em;
}
.scan-cards .scan-info-card .card-label {
  color: #a67c00;
}

  </style>
</head>
<body>
  
  <div class="transfer-container">
    <input id="scanInput" type="text" autofocus
    style="position:absolute;opacity:0;width:1px;height:1px;pointer-events:none;">
    <!-- –í–µ—Ä—Ö–Ω—è—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –∫–Ω–æ–ø–∫–∞ info -->
    <div class="header-info">
      <div class="static-header">
        {{ task.Turn if task.Turn else '–ü—Ä–∏—ë–º–∫–∞' }}
      </div>
      <div class="remaining-tasks">
        –û—Å—Ç–∞–ª–æ—Å—å –∑–∞–¥–∞—á: {{ remaining_tasks }}
      </div>
    </div>
    <button class="info-icon" id="infoIcon" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">‚ÑπÔ∏é</button>

    <!-- –ö–Ω–æ–ø–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ -->
    <button id="filterBtn" class="filter-btn" title="–§–∏–ª—å—Ç—Ä">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M3 5h18v2H3zm4 6h10v2H7zm2 6h6v2H9z"/>
      </svg>
    </button>
    <div id="filterMenu" class="filter-menu" style="padding: 12px;">
      <a href="{{ url_for('priemka_queue', mode='default', queue=queue) }}" class="filter-choice">üì¶ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</a>
      <a href="{{ url_for('priemka_queue', mode='articul', queue=queue) }}" class="filter-choice">üî§ –ü–æ –∞—Ä—Ç–∏–∫—É–ª—É</a>
    </div>

    <div class="info-popup" id="infoPopup">
      <button class="close-popup" id="closeInfoBtn">√ó</button>
      <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
      <p><strong>–°–∫–ª–∞–¥—Å–∫–∞—è –∑–∞–¥–∞—á–∞:</strong> {{ task.task_number }}</p>
      <p><strong>–î–æ–∫—É–º–µ–Ω—Ç:</strong> {% if task.id_deliveries is defined %}{{ task.id_deliveries }}{% endif %}</p>
      <p><strong>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</strong> {{ task.id_orders }}</p>
    </div>
    <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—á–∞—Ç–∏ —ç—Ç–∏–∫–µ—Ç–∫–∏ -->
    <button id="printLabelBtn" class="icon-btn" title="–ü–µ—á–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏">üñ®</button>
    <div id="printCountInput" class="manual-input hidden">
      <input id="printQtyField" type="number" min="1" placeholder="–ö–æ–ª-–≤–æ –∫–æ—Ä–æ–±–æ–∫">
      <button id="printConfirmBtn" class="btn">–ì–æ—Ç–æ–≤–æ</button>
      <button id="printCancelBtn" class="btn cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
    <div class="product-info">
      <span>{% if task.types %}{{ task.types }}{% else %}–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞{% endif %}</span>
      <span>({{ task.gender }} / {{ task.model }} / {{ task.color }})</span>
    </div>

    <!-- –°–µ–∫—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ—Ä–æ–±–∫–∏-–∏—Å—Ç–æ—á–Ω–∏–∫–∞ -->
    <div class="transfer-section source-section active" id="sourceSection">
      <button class="section-info" data-target="popup-source">‚ùî</button>
      <div id="popup-source" class="section-popup">
        <table>
          <tr><th>–ê—Ä—Ç–∏–∫—É–ª</th>   <td>{{ task.articul }}</td></tr>
          <tr><th>–†–∞–∑–º–µ—Ä</th>    <td>{{ task.sizes }}</td></tr>
          <tr><th>–†–æ—Å—Ç</th>      <td>{{ task.heights }}</td></tr>
          <tr><th>–†–æ—Å—Ç –≤ —Å–º</th> <td>{{ task.heightsrus }}</td></tr>
          <tr><th>–¢–∏–ø</th>       <td>{{ task.types }}</td></tr>
          <tr><th>–ú–æ–¥–µ–ª—å</th>    <td>{{ task.model }}</td></tr>
          <tr><th>–ü–æ–ª</th>       <td>{{ task.gender }}</td></tr>
          <tr><th>–¶–≤–µ—Ç</th>      <td>{{ task.color }}</td></tr>
        </table>
      </div>
      <h2>–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∫–æ—Ä–æ–±–∫—É-–∏—Å—Ç–æ—á–Ω–∏–∫
        <button class="edit-btn" id="editSourceBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
      </h2>
      <div class="info-block">
        <span class="label">–ö–æ—Ä–æ–±–∫–∞:</span>
        <strong id="sourceCell" class="cell-highlight"></strong>
      </div>
      <div id="manualSourceInput" class="manual-input">
        <input type="text" id="sourceInputField" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ—Ä–æ–±–∫–∏">
        <button id="saveSourceBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="cancelSourceBtn" style="background: #aaa;">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <div class="info-cards">
        <div class="info-card" id="articulCard">
          <div class="card-label">–ê—Ä—Ç–∏–∫—É–ª</div>
          <div class="card-value" id="article">{{ task.articul }}</div>
        </div>
        <div class="info-card" id="sizeCard">
          <div class="card-label">–†–∞/–†–æ</div>
          <div class="card-value" id="sizeHeightValue">{{ task.sizes }}/{{ task.heightsrus }}</div>
        </div>
        <div class="info-card" id="countCard">
          <div class="card-label">–®—Ç—É–∫</div>
          <div class="card-value" id="plannedQuantityValue">{{ task.counts }}</div>
        </div>
      </div>
      <p id="sourceStatus" class="status-text"></p>
    </div>

    <!-- –°–µ–∫—Ü–∏—è —Ü–µ–ª–µ–≤–æ–≥–æ –º–µ—Å—Ç–∞ -->
    <section id="targetSection" class="transfer-section hidden">
      <h2>–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Ü–µ–ª–µ–≤–æ–µ –º–µ—Å—Ç–æ</h2>
      <div class="info-cards scan-cards" style="margin-bottom: 15px;">
        <div class="info-card scan-info-card" id="articulCard3">
          <div class="card-label">–ê—Ä—Ç–∏–∫—É–ª</div>
          <div class="card-value" id="article3">{{ task.articul }}</div>
        </div>
        <div class="info-card scan-info-card" id="sizeCard3">
          <div class="card-label">–†–∞/–†–æ</div>
          <div class="card-value" id="sizeHeightValue3">{{ task.sizes }}/{{ task.heightsrus }}</div>
        </div>
        <div class="info-card scan-info-card" id="countCard3">
          <div class="card-label">–®—Ç—É–∫</div>
          <div class="card-value" id="plannedQuantityValue3">{{ task.counts }}</div>
        </div>
      </div>
      
      <button class="icon-btn section-info" data-target="popup-target" title="–ü–æ–º–æ—â—å">‚ùî</button>
      <button class="icon-btn circle-back" id="backToQuantity" title="–í–µ—Ä–Ω—É—Ç—å—Å—è">‚Üê</button>

      <div class="info-block">
        <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —è—á–µ–π–∫—É –∏–ª–∏ –∫–æ—Ä–æ–±–∫—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</p>
      </div>

      <div id="popup-target" class="section-popup">
        <button class="close-popup">√ó</button>
        <table>
          <tr><th>–ê—Ä—Ç–∏–∫—É–ª</th>   <td>{{ task.articul }}</td></tr>
          <tr><th>–†–∞–∑–º–µ—Ä</th>    <td>{{ task.sizes }}</td></tr>
          <tr><th>–†–æ—Å—Ç</th>      <td>{{ task.heights }}</td></tr>
          <tr><th>–†–æ—Å—Ç –≤ —Å–º</th> <td>{{ task.heightsrus }}</td></tr>
          <tr><th>–¢–∏–ø</th>       <td>{{ task.types }}</td></tr>
          <tr><th>–ú–æ–¥–µ–ª—å</th>    <td>{{ task.model }}</td></tr>
          <tr><th>–ü–æ–ª</th>       <td>{{ task.gender }}</td></tr>
          <tr><th>–¶–≤–µ—Ç</th>      <td>{{ task.color }}</td></tr>
        </table>
      </div>
    </section>

    <!-- –°–µ–∫—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ -->
    <section id="quantitySection" class="transfer-section hidden">
      <h2>–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Ç–æ–≤–∞—Ä—ã</h2>
      <div class="info-cards scan-cards" style="margin-bottom: 15px;">
        <div class="info-card scan-info-card" id="articulCard4">
          <div class="card-label">–ê—Ä—Ç–∏–∫—É–ª</div>
          <div class="card-value" id="article4">{{ task.articul }}</div>
        </div>
        <div class="info-card scan-info-card" id="sizeCard4">
          <div class="card-label">–†–∞/–†–æ</div>
          <div class="card-value" id="sizeHeightValue4">{{ task.sizes }}/{{ task.heightsrus }}</div>
        </div>
        <div class="info-card scan-info-card" id="countCard4">
          <div class="card-label">–®—Ç—É–∫</div>
          <div class="card-value" id="plannedQuantityValue4">{{ task.counts }}</div>
        </div>
      </div>
      
      <button class="icon-btn section-info" data-target="popup-quantity" title="–ü–æ–º–æ—â—å">‚ùî</button>
      <button class="icon-btn circle-back" id="backToQuantity" title="–í–µ—Ä–Ω—É—Ç—å—Å—è">‚Üê</button>
    
      <!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–∫–∞–Ω–æ–≤ –∏ —Å–ø–∏—Å–æ–∫ -->
      <div class="scan-block">
        <button class="icon-btn" id="clearScansBtn" title="–û—á–∏—Å—Ç–∏—Ç—å —Å–∫–∞–Ω—ã">üóë</button>
        <div class="scan-container">
          <div id="scanCount" class="scan-count">
            –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: 0 –∏–∑ {{ task.counts }} —à—Ç.
          </div>
          <ul id="scannedList" class="scan-list"></ul>
        </div>
      </div>
      
      <!-- Popup-–æ–∫–Ω–æ –¥–ª—è –∏–Ω—Ñ–æ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É -->
      <div id="popup-quantity" class="section-popup">
        <button class="close-popup">√ó</button>
        <table>
          <tr><th>–ê—Ä—Ç–∏–∫—É–ª</th>   <td>{{ task.articul }}</td></tr>
          <tr><th>–†–∞–∑–º–µ—Ä</th>    <td>{{ task.sizes }}</td></tr>
          <tr><th>–†–æ—Å—Ç</th>      <td>{{ task.heights }}</td></tr>
          <tr><th>–†–æ—Å—Ç –≤ —Å–º</th> <td>{{ task.heightsrus }}</td></tr>
          <tr><th>–¢–∏–ø</th>       <td>{{ task.types }}</td></tr>
          <tr><th>–ú–æ–¥–µ–ª—å</th>    <td>{{ task.model }}</td></tr>
          <tr><th>–ü–æ–ª</th>       <td>{{ task.gender }}</td></tr>
          <tr><th>–¶–≤–µ—Ç</th>      <td>{{ task.color }}</td></tr>
        </table>
      </div>
      
      <!-- –ù–∏–∂–Ω–∏–π –±–ª–æ–∫: –∫–Ω–æ–ø–∫–∞ –î–∞–ª—å—à–µ -->
      <div class="quantity-buttons">
        <button id="nextBtn" class="btn-primary hidden" disabled>–î–∞–ª—å—à–µ</button>
      </div>
    </section>
    
    <!-- –ù–∏–∂–Ω–∏–π –±–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ -->
    <div class="buttons-block">
      <!-- –†—è–¥ –∏–∑ –¥–≤—É—Ö –∫–Ω–æ–ø–æ–∫ -->
      <div class="buttons-row">
        <a id="skipBtn"
           class="btn-primary"
           href="{{ url_for('priemka_queue', skip=task.task_number, queue=queue) }}">
          –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
        </a>
        <a class="btn-secondary"
           href="{{ url_for('queue_turn', turn='–ü—Ä–∏—ë–º–∫–∞') }}">
          –í–µ—Ä–Ω—É—Ç—å—Å—è
        </a>
      </div>
    
      <!-- –ü–æ–¥ –Ω–∏–º–∏ ‚Äî –æ–¥–Ω–∞ –±–æ–ª—å—à–∞—è –∫–Ω–æ–ø–∫–∞ -->
      <form id="completeForm" method="post" action="{{ url_for('split_order') }}">
        <input type="hidden" name="order_id" value="{{ task.id_orders }}">
        <input type="hidden" name="turn" value="–ü—Ä–∏—ë–º–∫–∞">
        <input type="hidden" name="queue" value="{{ queue }}">
        <button type="submit" id="completeBtn" class="complete-btn">
          –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É
        </button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Info-popup ‚ÑπÔ∏é ---
      const infoIcon     = document.getElementById('infoIcon');
      const infoPopup    = document.getElementById('infoPopup');
      const closeInfoBtn = document.getElementById('closeInfoBtn');
      infoIcon?.addEventListener('click', e => {
        e.stopPropagation();
        infoPopup.style.display = infoPopup.style.display === 'block' ? 'none' : 'block';
      });
      closeInfoBtn?.addEventListener('click', () => infoPopup.style.display = 'none');
      document.addEventListener('click', () => infoPopup.style.display = 'none');

      // --- –§–∏–ª—å—Ç—Ä –∑–∞–¥–∞—á ---
      const filterBtn  = document.getElementById('filterBtn');
      const filterMenu = document.getElementById('filterMenu');
      filterBtn?.addEventListener('click', e => {
        e.stopPropagation();
        filterMenu.style.display = filterMenu.style.display === 'block' ? 'none' : 'block';
      });
      document.addEventListener('click', e => {
        if (!filterBtn?.contains(e.target) && !filterMenu?.contains(e.target))
          filterMenu.style.display = 'none';
      });

      // --- Section-info (‚ùî) –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ ---
      document.querySelectorAll('.section-info').forEach(btn => {
        const popup = document.getElementById(btn.dataset.target);
        btn.addEventListener('click', e => {
          e.stopPropagation();
          popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        });
      });
      document.addEventListener('click', () => {
        document.querySelectorAll('.section-popup').forEach(p => p.style.display = 'none');
      });
      document.querySelectorAll('.section-popup .close-popup').forEach(x => {
        x.addEventListener('click', e => {
          const popup = x.closest('.section-popup');
          popup.style.display = 'none';
        });
      });

      // --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —Å–µ–∫—Ü–∏–∏ ---
      const TASK_ID = parseInt("{{ task.task_number }}", 10);
      const sourceSection = document.getElementById('sourceSection');
      const quantitySection = document.getElementById('quantitySection');
      const targetSection = document.getElementById('targetSection');
      const scanInput = document.getElementById('scanInput');
      const scanBlock = document.querySelector('.scan-block');
      const backToSourceBtn = document.getElementById('backToSource');
      const backToQuantityBtn = document.getElementById('backToQuantity');
      const nextBtn = document.getElementById('nextBtn');
      const plannedQuantity = parseInt("{{ task.counts }}", 10);

      // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
      let step = 'source';
      let currentItems = [];
      let cycles = [];
      let sourceBox = null;
      let sourceBarcode = null;

      // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
      function showSection(name) {
        console.log('Switching to section:', name);
        sourceSection.classList.toggle('active', name === 'source');
        sourceSection.classList.toggle('hidden', name !== 'source');
        quantitySection.classList.toggle('active', name === 'quantity');
        quantitySection.classList.toggle('hidden', name !== 'quantity');
        targetSection.classList.toggle('active', name === 'target');
        targetSection.classList.toggle('hidden', name !== 'target');
        step = name;
        if (name === 'quantity') {
          quantitySection.scrollIntoView({ behavior: 'smooth' });
        }
        scanInput?.focus();
        console.log('Current state:', { step, sourceBox, sourceBarcode, itemsCount: currentItems.length });
      }

      function renderCycles() {
        // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        const scanned = cycles.reduce((sum, c) => sum + c.items.length, 0) + currentItems.length;
        const total = plannedQuantity;
        document.getElementById('scanCount').textContent = `–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${scanned} –∏–∑ ${total} —à—Ç.`;
        // –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã (—Ç–æ–≤–∞—Ä—ã + —Ü–µ–ª–µ–≤–∞—è)
        const closed = cycles.map(c => `
          <li class="scan-item">
            <div class="header">–¶–µ–ª–µ–≤–∞—è: ${c.target}</div>
            <div class="items">${c.items.map(it => it.articul).join(', ')}</div>
          </li>
        `).join('');
        // –¢–µ–∫—É—â–∏–π –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π —Ü–∏–∫–ª
        const current = currentItems.length
          ? `<li class="scan-item current">
              <div class="header">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Ç–æ–≤–∞—Ä</div>
              <div class="items">${currentItems.map(it => it.articul).join(', ')}</div>
            </li>`
          : '';
        document.getElementById('scannedList').innerHTML = closed + current;
        updateNextButton();
      }

      function updateNextButton() {
        // –ö–Ω–æ–ø–∫–∞ "–î–∞–ª—å—à–µ" –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
        const scanned = cycles.reduce((sum, c) => sum + c.items.length, 0);
        if (scanned >= plannedQuantity) {
          nextBtn.classList.remove('hidden');
          nextBtn.disabled = false;
        } else {
          nextBtn.classList.add('hidden');
          nextBtn.disabled = true;
        }
      }

      // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å Android ---
      window.onBarcodeScanned = function(scannedCode) {
        const code = scannedCode.trim();
        scanInput.value = code;
        const evt = new KeyboardEvent('keydown', { key: 'Enter', bubbles: true });
        document.dispatchEvent(evt);
      };

      // --- –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ---
      scanInput.focus();
      scanInput.addEventListener('blur', e => {
        const to = e.relatedTarget;
        if (to && (to.tagName === 'BUTTON' || to.tagName === 'A')) {
          return;
        }
        scanInput.focus();
      });

      // --- –û—á–∏—Å—Ç–∫–∞ —Å–∫–∞–Ω–æ–≤ ---
      const clearScansBtn = document.getElementById('clearScansBtn');
      clearScansBtn.onclick = async () => {
        currentItems = [];
        cycles = [];
        renderCycles();
        scanBlock.classList.remove('grayed');
        scanInput.disabled = false;
        await fetch('/priemka_queue/clear_scans', { method: 'POST' });
        nextBtn.classList.add('hidden');
        nextBtn.disabled = true;
      };

      // --- –ö–Ω–æ–ø–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ ---
      if (backToSourceBtn) {
        backToSourceBtn.addEventListener('click', () => {
          console.log('Clicking back to source');
          showSection('source');
        });
      }

      if (backToQuantityBtn) {
        backToQuantityBtn.addEventListener('click', () => {
          console.log('Clicking back to quantity');
          showSection('quantity');
        });
      }

      // --- –†—É—á–Ω–æ–π –≤–≤–æ–¥ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ ---
      const editSourceBtn = document.getElementById('editSourceBtn');
      const manualSourceInput = document.getElementById('manualSourceInput');
      const sourceInputField = document.getElementById('sourceInputField');
      const saveSourceBtn = document.getElementById('saveSourceBtn');
      const cancelSourceBtn = document.getElementById('cancelSourceBtn');
      const sourceStatusEl = document.getElementById('sourceStatus');
      const sourceCellElem = document.getElementById('sourceCell');
    
      editSourceBtn?.addEventListener('click', e => {
        e.stopPropagation();
        manualSourceInput.style.display = manualSourceInput.style.display === 'block' ? 'none' : 'block';
        if (manualSourceInput.style.display === 'block') {
          sourceInputField.value = '';
          sourceInputField.focus();
          editSourceBtn.classList.add('active');
        } else {
          editSourceBtn.classList.remove('active');
        }
      });

      cancelSourceBtn?.addEventListener('click', () => {
        manualSourceInput.style.display = 'none';
        sourceStatusEl.textContent = '';
        editSourceBtn.classList.remove('active');
      });

      saveSourceBtn?.addEventListener('click', async () => {
        const code = sourceInputField.value.trim();
        if (!code) {
          sourceStatusEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ—Ä–æ–±–∫–∏!';
          return;
        }
        try {
          const res = await fetch('/priemka_queue/validate_source', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ box_code: code })
          });
          const js = await res.json();
          if (js.status === 'success') {
            if (window.AndroidAudio && window.AndroidAudio.playSuccess) window.AndroidAudio.playSuccess();
            sourceBox = js.source;
            sourceBarcode = js.barcode;
            sourceCellElem.textContent = sourceBox;
            sourceCellElem.classList.add('confirmed-cell');
            sourceSection.classList.add('confirmed');
            manualSourceInput.style.display = 'none';
            sourceStatusEl.textContent = '';
            editSourceBtn.classList.remove('active');
            showSection('quantity');
            await fetch('/priemka_queue/clear_scans', { method: 'POST' });
            currentItems = [];
            cycles = [];
            renderCycles();
          } else {
            if (window.AndroidAudio && window.AndroidAudio.playError) window.AndroidAudio.playError();
            sourceStatusEl.textContent = js.message || '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ—Ä–æ–±–∫–∏';
          }
        } catch (e) {
          if (window.AndroidAudio && window.AndroidAudio.playError) window.AndroidAudio.playError();
          sourceStatusEl.textContent = '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
        }
      });

      // --- –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ---
      document.addEventListener('keydown', async e => {
        if (e.key !== 'Enter') return;
        e.preventDefault();
        const code = (scanInput.value || '').trim();
        scanInput.value = '';
        if (!code) return;

        // –®–∞–≥ 1: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä–æ–±–∫–∏-–∏—Å—Ç–æ—á–Ω–∏–∫–∞
        if (step === 'source') {
          try {
            const res = await fetch('/priemka_queue/validate_source', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ box_code: code })
            });
            const js = await res.json();
            if (js.status === 'success') {
              if (window.AndroidAudio && window.AndroidAudio.playSuccess) window.AndroidAudio.playSuccess();
              sourceBox = js.source;
              sourceBarcode = js.barcode;
              sourceCellElem.textContent = sourceBox;
              sourceCellElem.classList.add('confirmed-cell');
              sourceSection.classList.add('confirmed');
              manualSourceInput.style.display = 'none';
              sourceStatusEl.textContent = '';
              editSourceBtn.classList.remove('active');
              showSection('quantity');
              await fetch('/priemka_queue/clear_scans', { method: 'POST' });
              currentItems = [];
              cycles = [];
              renderCycles();
            } else {
              if (window.AndroidAudio && window.AndroidAudio.playError) window.AndroidAudio.playError();
              sourceStatusEl.textContent = js.message || '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ—Ä–æ–±–∫–∏';
            }
          } catch (e) {
            if (window.AndroidAudio && window.AndroidAudio.playError) window.AndroidAudio.playError();
            sourceStatusEl.textContent = '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
          }
          return;
        }

        // –®–∞–≥ 2: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Ü–µ–ª–µ–≤–æ–π
        if (step === 'quantity') {
          try {
            const res = await fetch('/priemka_queue/scan', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code, source_box: sourceBarcode })
            });
            const js = await res.json();
            Swal.fire({
              title: '–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞',
              text: JSON.stringify(js),
              timer: 4000
            });
            if (js.status === 'success') {
              if (window.AndroidAudio && window.AndroidAudio.playSuccess) window.AndroidAudio.playSuccess();
              currentItems.push(js.record);
              renderCycles();
              return;
            }
          } catch (e) {
            if (window.AndroidAudio && window.AndroidAudio.playError) window.AndroidAudio.playError();
            Swal.fire({ icon: 'error', title: '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
            return;
          }
          // 2. –ï—Å–ª–∏ –Ω–µ —Ç–æ–≤–∞—Ä ‚Äî –ø—Ä–æ–±—É–µ–º –∫–∞–∫ —Ü–µ–ª–µ–≤—É—é
          if (currentItems.length === 0) {
            if (window.AndroidAudio && window.AndroidAudio.playError) window.AndroidAudio.playError();
            Swal.fire({ icon: 'warning', title: '–°–Ω–∞—á–∞–ª–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Ç–æ–≤–∞—Ä', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
            return;
          }
          try {
            const targetRes = await fetch('/priemka_queue/validate_target', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code })
            });
            const targetJs = await targetRes.json();
            if (targetJs.status === 'success') {
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–∏–∫–ª: —Ç–æ–≤–∞—Ä—ã + —Ü–µ–ª–µ–≤–∞—è
              cycles.push({ items: currentItems.slice(), target: code });
              currentItems = [];
              renderCycles();
            } else {
              if (window.AndroidAudio && window.AndroidAudio.playError) window.AndroidAudio.playError();
              Swal.fire({ icon: 'error', title: targetJs.message || '–ù–µ–≤–µ—Ä–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
            }
          } catch (e) {
            if (window.AndroidAudio && window.AndroidAudio.playError) window.AndroidAudio.playError();
            Swal.fire({ icon: 'error', title: '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
          }
          return;
        }
      });

      // --- –ö–Ω–æ–ø–∫–∞ "–î–∞–ª—å—à–µ" ---
      nextBtn.addEventListener('click', async () => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º ‚Äî –µ—Å–ª–∏ –Ω–µ –≤—Å–µ —à—Ç—É–∫–∏, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        let scanned = cycles.reduce((sum, c) => sum + c.items.length, 0);
        if (scanned < plannedQuantity) {
          const res = await Swal.fire({
            icon: 'warning',
            title: `–í—ã —É–≤–µ—Ä–µ–Ω—ã? –û—Å—Ç–∞–ª–æ—Å—å –Ω–µ–æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ ${plannedQuantity - scanned} –∏–∑ ${plannedQuantity} —à—Ç—É–∫.`,
            showCancelButton: true,
            confirmButtonText: '–î–∞, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
            cancelButtonText: '–û—Ç–º–µ–Ω–∞'
          });
          if (!res.isConfirmed) return;
        }
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        try {
          const res = await fetch('/priemka_queue/update_task', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ cycles, source_box: sourceBarcode })
          });
          const js = await res.json();
          if (res.ok && js.status === 'success') {
            window.location.reload();
          } else {
            Swal.fire({ icon: 'error', title: '–û—à–∏–±–∫–∞', text: js.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
          }
        } catch (e) {
          Swal.fire({ icon: 'error', title: '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏', text: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
        }
      });

      // --- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã ---
      const form = document.getElementById('completeForm');
      const remaining = parseInt(document.querySelector('.remaining-tasks').textContent.match(/\d+/)[0], 10) || 0;
    
      form.addEventListener('submit', function(e) {
        e.preventDefault();
      
        Swal.fire({
          title: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ',
          text: `–û—Å—Ç–∞–ª–æ—Å—å ${remaining} —Å–∫–ª–∞–¥—Å–∫–∏—Ö –∑–∞–¥–∞—á. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É?`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: '–î–∞, –∑–∞–≤–µ—Ä—à–∏—Ç—å',
          cancelButtonText: '–ù–µ—Ç'
        }).then(result => {
          if (result.isConfirmed) {
            form.submit();
          }
        });
      });

      // --- –ù–∞—á–∞–ª—å–Ω—ã–π —Ñ–æ–∫—É—Å ---
      scanInput?.focus();
      renderCycles();
    });
  </script>
</body>
</html>