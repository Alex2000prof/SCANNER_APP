<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü–µ—Ä–µ–Ω–æ—Å —Ç–æ–≤–∞—Ä–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º SweetAlert2 –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"> -->


  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
    html, body {
      font-family: 'Montserrat', sans-serif;
    }
    html, body {
    overflow-x: hidden;
    margin: 0;
    padding: 0;
   }
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }
    .transfer-container {
      width: 90%;
      max-width: 600px;
      background: #fff;
      border: 1px solid #ff3c00;
      border-radius: 0px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
      position: relative;
      padding: 20px 20px 60px 20px;
    }
    /* Info-–∫–Ω–æ–ø–∫–∞ –≤ —Å–∞–º–æ–º –≤–µ—Ä—Ö–Ω–µ–º –ø—Ä–∞–≤–æ–º —É–≥–ª—É */
    .info-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      background: linear-gradient(135deg, #ff3c00, #ff7733);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.5em;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.3s;
      z-index: 3;
    }
    .info-icon:hover {
      background: linear-gradient(135deg, #e04400, #ff5733);
    }
    /* Popup —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π */
    .info-popup {
      display: none;
      position: absolute;
      top: 60px;
      right: 10px;
      background: linear-gradient(135deg, #fff, #f0f0f0);
      border: 2px solid #ff3c00;
      border-radius: 8px;
      padding: 10px;
      width: 260px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 3;
    }
    .info-popup h3 {
      margin: 0 0 5px;
      font-size: 1.2em;
      color: #ff3c00;
    }
    .info-popup p {
      margin: 3px 0;
      font-size: 1em;
      color: #333;
    }
    .info-popup .close-popup {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      color: #ff3c00;
    }
    .header-info {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #ccc;
    }

    .static-header {
      font-size: 2em;
      color: #ff3c00;
      line-height: 1.1;  /* —á—É—Ç—å –ø–ª–æ—Ç–Ω–µ–µ —Å—Ç—Ä–æ–∫–∏ */
      text-align: center;
    }

    .warehouse-task-number,
    .doc-info,
    .remaining-tasks {
      font-size: 1.2em;
      margin: 3px 0;
      color: #333;
      font-weight: 600;
    }
    /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ */
    .product-info {
      text-align: center;
      font-size: 1.2em;
      color: #555;
      margin-bottom: 10px;
    }
    .product-info span {
      display: block;
    }
    /* –°–µ–∫—Ü–∏–∏ */
    .transfer-section {
      margin-bottom: 15px;
      padding: 20px;
      background: linear-gradient(135deg, #fafafa, #f0f0f0);
      border: 2px solid #ccc;
      border-radius: 8px;
      transition: border-color 0.3s, background 0.3s, color 0.3s;
      position: relative;
    }
    .transfer-section.active {
      border-color: #FFD700;
      background: linear-gradient(135deg, #fff8e1, #fff3cd);
      color: #444;
    }
    .transfer-section.confirmed {
      color: #333 !important;
      border-color: #28a745;
      background: linear-gradient(135deg, #eaffea, #d4f7d4);
      color: #fff;
    }
    .transfer-section h2 {
      margin: 0 0 10px;
      font-size: 1.4em;
      color: inherit;
      text-align: center;
      border-bottom: 2px solid #ccc;
      padding-bottom: 5px;
    }

    /* –†—É—á–Ω–æ–π –≤–≤–æ–¥ */
    .manual-input {
      display: none;
      margin-top: 10px;
      text-align: center;
    }
    .manual-input input {
      padding: 8px;
      font-size: 1em;
      border: 2px solid #ff3c00;
      border-radius: 4px;
      width: 60%;
      margin-bottom: 5px;
    }
    .manual-input button {
      padding: 8px 15px;
      font-size: 1em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 5px;
      background: linear-gradient(135deg, #FF3366, #FF7733);
      color: #fff;
      transition: background 0.3s;
    }
    .manual-input button:hover {
      background: linear-gradient(135deg, #FF2255, #FF6633);
    }
    /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ */
    .info-block {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1em;
      font-weight: bold;
      color: inherit;
    }
    .cell-highlight {
      display: block;
      font-size: 2em;
      font-weight: bold;
      padding: 10px 20px;
      background-color: #ff3c00;
      color: #fff;
      border-radius: 8px;
      margin: 5px auto;
      transition: background-color 0.3s;
    }
    .confirmed-cell {
      background-color: #28a745 !important;
    }
    .status-text {
      text-align: center;
      font-size: 1.1em;
      color: #888;
      margin-top: 5px;
    }
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–ê—Ä—Ç–∏–∫—É–ª, –†–∞/–†–æ, –®—Ç—É–∫) */
    .info-cards {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .info-card {
      background: #ff3c00;
      color: #fff;
      border-radius: 8px;
      width: 100px;
      height: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
      transition: background 0.3s;
    }
    .info-card:hover {
      background: #ff5722;
    }
    .card-label {
      font-size: 0.7em;
      opacity: 0.9;
    }
    .card-value {
      font-size: 1.1em;
      font-weight: bold;
      margin-top: 3px;
    }
    /* –ë–ª–æ–∫ "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" */
    .quantity-block {
      text-align: center;
      margin-top: 15px;
      position: relative;
    }
    .quantity-block input[type="number"] {
      width: 100px;
      padding: 10px;
      font-size: 1.3em;
      border: 2px solid #ccc;
      border-radius: 6px;
      margin-right: 10px;
      transition: border-color 0.3s;
    }
    .quantity-block input[type="number"]:focus {
      border-color: #ff3c00;
      outline: none;
    }
    .quantity-block .btn {
      padding: 10px 20px;
      font-size: 1.3em;
      background: linear-gradient(135deg, #FF3366, #FF7733);
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: background 0.3s, transform 0.2s;
    }
    .quantity-block .btn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .quantity-block .btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #FF2255, #FF6633);
      transform: translateY(-2px);
    }
    .back-btn-qty {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6a00, #ee0979);
      color: #fff;
      font-size: 1.8em;
      cursor: pointer;
      outline: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background 0.3s, transform 0.2s;
    }
    .back-btn-qty:hover {
      background: linear-gradient(135deg, #e05500, #d80a70);
      transform: scale(1.05);
    }
    /* –ù–∏–∂–Ω–∏–π –±–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ */
    .bottom-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      gap: 20px;
    }
    .back-btn, .skip-btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 1.1em;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.3s;
      flex: 1;
      text-align: center;
    }
    .back-btn {
      background: #333;
      color: #fff;
    }
    .back-btn:hover {
      background: #555;
    }
    .skip-btn {
      background: #007bff;
      color: #fff;
      border: none;
    }
    .skip-btn:hover {
      background: #0056b3;
    }

    /* 1) –û–±—â–∏–π —Å—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–π */
.transfer-section .section-info,
.transfer-section .edit-btn {
  position: absolute;
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #ff3c00, #ff7733);
  color: #fff;
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2em;
  cursor: pointer;
  transition: transform .2s, background .2s;
  z-index: 10;
}
/* info —Å–ª–µ–≤–∞, edit —Å–ø—Ä–∞–≤–∞ */
.transfer-section .section-info {
  top: 8px;
  left: 8px;
}
.transfer-section .edit-btn {
  top: 8px;
  right: 8px;
}
/* hover‚Äë—ç—Ñ—Ñ–µ–∫—Ç */
.transfer-section .section-info:hover,
.transfer-section .edit-btn:hover {
  transform: scale(1.1);
  background: linear-gradient(135deg, #e04400, #ff5733);
}

/* 2) –ö—Ä–∞—Å–∏–≤—ã–π, –ª—ë–≥–∫–∏–π popup‚Äë–±–ª–æ–∫ */
.section-popup {
  display: none;
  position: absolute;
  border: 1.5px solid #ff3c00;
  top: 42px;        /* –ø–æ–¥ 32px‚Äë–∫–Ω–æ–ø–∫–æ–π + 8px –æ—Ç—Å—Ç—É–ø */
  left: 8px;        /* —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ª–µ–≤—ã–º –æ—Ç—Å—Ç—É–ø–æ–º –∫–Ω–æ–ø–∫–∏ ‚ùî */
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
  padding: 12px;
  z-index: 20;
  min-width: 200px;
}

/* –¢–∞–±–ª–∏—Ü–∞ –≤–Ω—É—Ç—Ä–∏ pop‚Äëup, –∑–µ–±—Ä–∞‚Äë—à–∞–±–ª–æ–Ω, —á–∏—Ç–∞–µ–º–æ—Å—Ç—å */
.section-popup table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9em;
}
.section-popup th,
.section-popup td {
  padding: 8px 10px;
  text-align: left;
}
.section-popup th {
  background: #ff3c00;
  color: #fff;
  font-weight: 600;
  border-bottom: 2px solid #e0e0e0;
}
.section-popup tr:nth-child(odd) {
  background: #f9f9f9;
}
.section-popup tr:nth-child(even) {
  background: #fff;
}
.filter-btn {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 42px;
  height: 42px;
  background: linear-gradient(135deg,#ff3c00,#ff7733);
  border: none;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  z-index: 10;
}
.filter-btn svg {
  width: 22px;
  height: 22px;
  fill: #fff;
}
.filter-menu {
  display: none;
  position: absolute;
  top: 60px;
  left: 10px;
  background: #fff;
  border: 2px solid #ff3c00;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,.2);
  z-index: 99;
  padding: 8px 0;
  min-width: 240px;
}
.filter-option {
  padding: 12px 16px;
  font-size: 1rem;
  color: #333;
  cursor: pointer;
  transition: background 0.2s ease;
}
.filter-option:hover {
  background: #ffe0d3;
}
.filter-choice {
    display: block;
    background: linear-gradient(135deg, #ff3c00, #ff7733);
    color: #fff;
    font-weight: 600;
    text-align: center;
    text-decoration: none;
    border-radius: 10px;
    padding: 12px;
    margin: 6px 0;
    transition: background 0.3s, transform 0.2s;
  }
  .filter-choice:hover {
    background: linear-gradient(135deg, #e04400, #ff5733);
    transform: scale(1.05);
  }
  
  .circle-back {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(135deg, #ff3c00, #ff7733);
  color: #fff;
  font-size: 1.2em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.transfer-section.quantity-block.grayed {
  opacity: 0.5;
  pointer-events: none;
}
/* –ö–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª –æ—Å—Ç–∞—ë—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π */
.transfer-section.quantity-block.grayed .circle-back {
  opacity: 1;
  pointer-events: auto;
}
/* –ö–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –±–ª–æ–∫–∞ */
.hidden {
  display: none;
}

/* –ö–ª–∞—Å—Å –¥–ª—è ¬´–∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è¬ª –±–ª–æ–∫–∞ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ */
.grayed {
  opacity: 0.5;
  pointer-events: none;
}
/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ—Ö —Ç—Ä—ë—Ö –∫–Ω–æ–ø–æ–∫ */
.buttons-block {
  width: 100%;
  max-width: 600px;
  margin: 0 auto 2em;
  box-sizing: border-box;
}

/* –ü–µ—Ä–≤—ã–π —Ä—è–¥: –¥–≤–µ –∫–Ω–æ–ø–∫–∏ —Ä—è–¥–æ–º */
.buttons-row {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}
.buttons-row a {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  padding: .8em 0;
  border-radius: 6px;
  color: #fff;
  font-size: 1.2em;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  transition: background .3s, transform .1s;
}

/* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
.btn-primary {
  background: linear-gradient(135deg, #33a7ff, #a0e1ff);
}
.btn-primary:hover {
  background: linear-gradient(135deg, #14d0ff, #02a2ff);
}

/* –ß—ë—Ä–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
.btn-secondary,
.complete-btn {
  background: #333;
}
.btn-secondary:hover,
.complete-btn:hover {
  background: #555;
}
.complete-btn {
  display: block;
  width: 100%;
  padding: .8em 0;
  margin: 0;
  border: none;
  border-radius: 6px;
  color: #fff;
  font-size: 1.2em;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  transition: background .3s, transform .1s;
}
/* –§–∏–∫—Å–∏—Ä—É–µ–º ¬´–æ—Ä–∞–Ω–∂–µ–≤—ã–π¬ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
.transfer-container {
  position: fixed;      /* –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫ –æ–∫–Ω—É */
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  padding: 5px;        /* –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –æ—Ç –≥—Ä–∞–Ω–∏—Ü */
  box-sizing: border-box;
  overflow-y: auto;     /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
  overflow-x: hidden;   /* –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –Ω–µ –±—É–¥–µ—Ç */
}

/* –û—Ç–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª —É html/body */
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  height: 100%;
}

  </style>
</head>
<body>
  <div class="transfer-container">
    <!-- –í–µ—Ä—Ö–Ω—è—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –∫–Ω–æ–ø–∫–∞ info -->
    <div class="header-info">
      <div class="static-header">
        –ü–µ—Ä–µ–Ω–æ—Å<br>—Ç–æ–≤–∞—Ä–∞
      </div>
      <div class="remaining-tasks">
        –û—Å—Ç–∞–ª–æ—Å—å –∑–∞–¥–∞—á: {{ task.remaining_tasks }}
      </div>
    </div>
    <button class="info-icon" id="infoIcon" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">‚ÑπÔ∏é</button>

        <!-- 1) –ö–Ω–æ–ø–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ -->
        <button id="filterBtn" class="filter-btn" title="–§–∏–ª—å—Ç—Ä">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M3 5h18v2H3zm4 6h10v2H7zm2 6h6v2H9z"/>
          </svg>
        </button>
        <div id="filterMenu" class="filter-menu" style="padding: 12px;">
          <a href="{{ url_for('transfer', mode='default', queue=queue) }}"
             class="filter-choice">üì¶ –£–º–Ω—ã–π</a>
          <a href="{{ url_for('transfer', mode='articul', queue=queue) }}"
             class="filter-choice">üî§ –ê—Ä—Ç–∏–∫—É–ª—ã</a>
        </div>


    <div class="info-popup" id="infoPopup">
      <button class="close-popup" id="closeInfoBtn">√ó</button>
      <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
      <p><strong>–°–∫–ª–∞–¥—Å–∫–∞—è –∑–∞–¥–∞—á–∞:</strong> {{ task.task_number }}</p>
      <p><strong>–î–æ–∫—É–º–µ–Ω—Ç:</strong> {% if task.id_deliveries is defined %}{{ task.id_deliveries }}{% endif %}</p>
      <p><strong>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</strong> {{ task.id_orders }}</p>
    </div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
    <div class="product-info">
      <span>{% if task.types %}{{ task.types }}{% else %}–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞{% endif %}</span>
      <span>({{ task.gender }} / {{ task.model }} / {{ task.color }})</span>
    </div>
    
    <!-- –°–µ–∫—Ü–∏—è "–û—Ç–∫—É–¥–∞" -->
    <div class="transfer-section source-section active" id="sourceSection">
      <button class="section-info" data-target="popup-source">‚ùî</button>
      <div id="popup-source" class="section-popup">
        <table>
          <tr><th>–ê—Ä—Ç–∏–∫—É–ª</th>   <td>{{ task.articul }}</td></tr>
          <tr><th>–†–∞–∑–º–µ—Ä</th>    <td>{{ task.sizes }}</td></tr>
          <tr><th>–†–æ—Å—Ç</th>      <td>{{ task.heights }}</td></tr>
          <tr><th>–†–æ—Å—Ç –≤¬†—Å–º</th> <td>{{ task.heightsrus }}</td></tr>
          <tr><th>–¢–∏–ø</th>       <td>{{ task.types }}</td></tr>
          <tr><th>–ú–æ–¥–µ–ª—å</th>    <td>{{ task.model }}</td></tr>
          <tr><th>–ü–æ–ª</th>       <td>{{ task.gender }}</td></tr>
          <tr><th>–¶–≤–µ—Ç</th>      <td>{{ task.color }}</td></tr>
        </table>
      </div>
      <h2>–û—Ç–∫—É–¥–∞
        <button class="edit-btn" id="editSourceBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
      </h2>
      <div class="info-block">
        <span class="label">–Ø—á–µ–π–∫–∞:</span>
        <strong id="sourceCell" class="cell-highlight">{{ task.from_cell }}</strong>
      </div>
      <div id="manualSourceInput" class="manual-input">
        <input type="text" id="sourceInputField" placeholder="–í–≤–µ–¥–∏—Ç–µ —è—á–µ–π–∫—É">
        <button id="saveSourceBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="cancelSourceBtn" style="background: #aaa;">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <div class="info-cards">
        <div class="info-card" id="articulCard">
          <div class="card-label">–ê—Ä—Ç–∏–∫—É–ª</div>
          <div class="card-value" id="article">{{ task.articul }}</div>
        </div>
        <div class="info-card" id="sizeCard">
          <div class="card-label">–†–∞/–†–æ</div>
          <div class="card-value" id="sizeHeightValue">{{ task.sizes }}/{{ task.heightsrus }}</div>
        </div>
        <div class="info-card" id="countCard">
          <div class="card-label">–®—Ç—É–∫</div>
          <div class="card-value" id="plannedQuantityValue">{{ task.counts }}</div>
        </div>
      </div>
      <p id="sourceStatus" class="status-text"></p>
    </div>
    
    <!-- –°–µ–∫—Ü–∏—è "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" -->
    <!-- –°–µ–∫—Ü–∏—è "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å—á—ë—Ç—á–∏–∫) -->
    <div class="transfer-section quantity-block" id="quantitySection" style="display: none; position: relative;">
      <!-- –ö—Ä—É–≥–ª–∞—è –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª -->
      <button id="backToScan" class="circle-back" title="–ù–∞–∑–∞–¥">
        ‚üµ
      </button>
    
      <h2>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</h2>
      <p class="status-text">
        –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: 
        <strong id="scannedCount">0</strong>
        –∏–∑ 
        <strong id="plannedCount">{{ task.counts }}</strong>
      </p>
    
      <button id="finishScan" class="btn finish-scan" style="display: none;">
        –ì–æ—Ç–æ–≤–æ
      </button>
    </div>

    
    <!-- –°–µ–∫—Ü–∏—è "–ö—É–¥–∞" -->
    <div class="transfer-section target-section hidden" id="targetSection">
        <button class="section-info" data-target="popup-target">‚ùî</button>
        <div id="popup-target" class="section-popup">
        <table>
          <tr><th>–ê—Ä—Ç–∏–∫—É–ª</th>   <td>{{ task.articul }}</td></tr>
          <tr><th>–†–∞–∑–º–µ—Ä</th>    <td>{{ task.sizes }}</td></tr>
          <tr><th>–†–æ—Å—Ç</th>      <td>{{ task.heights }}</td></tr>
          <tr><th>–†–æ—Å—Ç –≤¬†—Å–º</th> <td>{{ task.heightsrus }}</td></tr>
          <tr><th>–¢–∏–ø</th>       <td>{{ task.types }}</td></tr>
          <tr><th>–ú–æ–¥–µ–ª—å</th>    <td>{{ task.model }}</td></tr>
          <tr><th>–ü–æ–ª</th>       <td>{{ task.gender }}</td></tr>
          <tr><th>–¶–≤–µ—Ç</th>      <td>{{ task.color }}</td></tr>
        </table>
      </div>
      <h2>–ö—É–¥–∞
        <button class="edit-btn" id="editTargetBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
      </h2>
      <div class="info-block">
        <span class="label">–Ø—á–µ–π–∫–∞:</span>
        <strong id="targetCell" class="cell-highlight">{% if task.target_cell %}{{ task.target_cell }}{% else %}?{% endif %}</strong>
      </div>
      <div id="manualTargetInput" class="manual-input">
        <input type="text" id="targetInputField" placeholder="–í–≤–µ–¥–∏—Ç–µ —è—á–µ–π–∫—É">
        <button id="saveTargetBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="cancelTargetBtn" style="background: #aaa;">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <p id="targetStatus" class="status-text">–û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–ª–µ–≤–æ–π —è—á–µ–π–∫–∏...</p>
    </div>
    
    <div class="buttons-block">
    <!-- –†—è–¥ –∏–∑ –¥–≤—É—Ö –∫–Ω–æ–ø–æ–∫ -->
    <div class="buttons-row">
      <a id="skipBtn"
         class="btn-primary"
         href="{{ url_for('transfer',
                         skip=task.task_number,
                         queue=queue) }}">
        –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
      </a>
      {% if request.args.get('mode') %}
        <a class="btn-secondary"
           href="{{ url_for('queue_turn',
                           turn=queue) }}">
          –í–µ—Ä–Ω—É—Ç—å—Å—è
        </a>
      {% else %}
        <a class="btn-secondary"
           href="{{ url_for('queue_turn', turn=queue) }}">
          –í–µ—Ä–Ω—É—Ç—å—Å—è
        </a>
      {% endif %}
    </div>
  
    <!-- –ü–æ–¥ –Ω–∏–º–∏ ‚Äî –æ–¥–Ω–∞ –±–æ–ª—å—à–∞—è –∫–Ω–æ–ø–∫–∞ -->
    <form method="post" action="{{ url_for('split_order') }}">
      <input type="hidden" name="order_id" value="{{ task.id_orders }}">

      <input type="hidden" name="turn"     value="{{ queue }}">
      <input type="hidden" name="mode"     value="{{ request.args.get('mode','') }}">
      <button type="submit" class="complete-btn">
        –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É
      </button>
    </form>
    
  </div>
  
  <script>
    
    let taskState = {
      sourceScanned: false,
      quantityConfirmed: false,
      targetScanned: false,
      plannedQuantity: parseInt(document.getElementById('plannedQuantityValue').textContent) || 0
    };

    const sourceStatusEl = document.getElementById('sourceStatus');
    const targetStatusEl = document.getElementById('targetStatus');
    const quantitySection = document.getElementById('quantitySection');
    const quantityInput   = quantitySection.querySelector('input[type="number"]');
    const confirmQtyBtn   = quantitySection.querySelector('.btn');          // –∫–Ω–æ–ø–∫–∞ ¬´–ì–æ—Ç–æ–≤–æ¬ª –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
    const backQtyBtn      = document.getElementById('backToScan');
    const skipBtn = document.getElementById('skipBtn');
    const TASK_ID = parseInt("{{ task.task_number }}", 10);
    // Info popup
    const infoIcon = document.getElementById('infoIcon');
    const infoPopup = document.getElementById('infoPopup');
    const closeInfoBtn = document.getElementById('closeInfoBtn');
    infoIcon.addEventListener("click", function(e) {
      e.stopPropagation();
      infoPopup.style.display = (infoPopup.style.display === "block") ? "none" : "block";
    });
    if(closeInfoBtn){
      closeInfoBtn.addEventListener("click", function(){
        infoPopup.style.display = "none";
      });
    }
    
    // –†—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è "–û—Ç–∫—É–¥–∞"
    const editSourceBtn = document.getElementById('editSourceBtn');
    const manualSourceInput = document.getElementById('manualSourceInput');
    const sourceInputField = document.getElementById('sourceInputField');
    const saveSourceBtn = document.getElementById('saveSourceBtn');
    const cancelSourceBtn = document.getElementById('cancelSourceBtn');

    editSourceBtn.addEventListener("click", function(e) {
      e.stopPropagation();
      if (manualSourceInput.style.display === "none" || manualSourceInput.style.display === "") {
        manualSourceInput.style.display = "block";
        sourceInputField.value = "";
        sourceInputField.focus();
        editSourceBtn.classList.add("active");
      } else {
        manualSourceInput.style.display = "none";
        editSourceBtn.classList.remove("active");
      }
    });

    saveSourceBtn.addEventListener("click", function() {
      let manualValue = sourceInputField.value.trim();
      if(manualValue) {
        // –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ –Ω–µ–≤–µ—Ä–Ω–æ, –≤—ã–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –∏ –Ω–µ –º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
        let expected = document.getElementById('sourceCell').textContent.trim();
        if(manualValue !== expected) {
          sourceStatusEl.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —è—á–µ–π–∫–∏!";
          sourceStatusEl.style.color = "red";
          setTimeout(() => { sourceStatusEl.textContent = ""; }, 2000);
          return;
        }
        manualSourceInput.style.display = "none";
        editSourceBtn.classList.remove("active");
        processSourceScan(manualValue);
      }
    });

    cancelSourceBtn.addEventListener("click", function() {
      manualSourceInput.style.display = "none";
      editSourceBtn.classList.remove("active");
    });

    // –†—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è "–ö—É–¥–∞"
    const editTargetBtn = document.getElementById('editTargetBtn');
    const manualTargetInput = document.getElementById('manualTargetInput');
    const targetInputField = document.getElementById('targetInputField');
    const saveTargetBtn = document.getElementById('saveTargetBtn');
    const cancelTargetBtn = document.getElementById('cancelTargetBtn');

    editTargetBtn.addEventListener("click", function(e) {
      e.stopPropagation();
      if (manualTargetInput.style.display === "none" || manualTargetInput.style.display === "") {
        manualTargetInput.style.display = "block";
        targetInputField.value = "";
        targetInputField.focus();
        editTargetBtn.classList.add("active");
      } else {
        manualTargetInput.style.display = "none";
        editTargetBtn.classList.remove("active");
      }
    });

    saveTargetBtn.addEventListener("click", function() {
      let manualValue = targetInputField.value.trim();
      if(manualValue) {
        let expected = document.getElementById('targetCell').textContent.trim();
        if(expected !== '?' && manualValue !== expected) {
          targetStatusEl.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —è—á–µ–π–∫–∏!";
          targetStatusEl.style.color = "red";
          setTimeout(() => { 
            targetStatusEl.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–ª–µ–≤–æ–π —è—á–µ–π–∫–∏...";
            targetStatusEl.style.color = "#888";
          }, 2000);
          return;
        }
        manualTargetInput.style.display = "none";
        editTargetBtn.classList.remove("active");
        processTargetScan(manualValue);
      }
    });

    cancelTargetBtn.addEventListener("click", function() {
      manualTargetInput.style.display = "none";
      editTargetBtn.classList.remove("active");
    });

    // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" - –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–µ
    // skipBtn.addEventListener("click", function() {
    //   window.location.href = "/transfer";
    // });

    // –≠–º—É–ª—è—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ —Å–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤
    // –≠–º—É–ª—è—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ —Å–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤
    // –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫ —Ü–µ–ª–∏–∫–æ–º –≤ <script> –≤–∞—à–µ–≥–æ transfer.html, –∑–∞–º–µ–Ω–∏–≤ —Ç–µ–∫—É—â—É—é —Ñ—É–Ω–∫—Ü–∏—é window.onBarcodeScanned
      window.onBarcodeScanned = function(scannedCode) {
      scannedCode = scannedCode.trim();
      const qtySec    = document.getElementById('quantitySection');
      const scCountEl = document.getElementById('scannedCount');
      const finishBtn = document.getElementById('finishScan');
      const backBtn   = document.getElementById('backToScan');

      // 1) –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ¬´–û—Ç–∫—É–¥–∞¬ª
      if (!taskState.sourceScanned) {
        processSourceScan(scannedCode);
        return;
      }

      // 2) –°–∫–∞–Ω —Ç–æ–≤–∞—Ä–∞ (—Å–µ–∫—Ü–∏—è ‚Äú–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ‚Äù)
      if (taskState.sourceScanned && !taskState.quantityConfirmed) {
        // –±–ª–æ–∫–∏—Ä—É–µ–º –¥—É–±–ª–∏ –∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ
        taskState.scannedCodes = taskState.scannedCodes || new Set();
        if (taskState.scannedCodes.has(scannedCode)) {
          return Swal.fire({ title: '–≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä —É–∂–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω', icon: 'error' });
        }
        if (taskState.scannedCount >= taskState.plannedQuantity) {
          return Swal.fire({ title: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ', icon: 'warning' });
        }

        // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–µ–∫—Ü–∏–∏ ¬´–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ¬ª
        qtySec.classList.add('active');

        // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch('/transfer/scan_item', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: scannedCode, task_id: TASK_ID })
        })
        .then(r => r.json())
        .then(data => {
          if (data.status === 'success') {
            window.AndroidAudio.playSuccess();
            // –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
            taskState.scannedCount = data.scanned_count;
            taskState.scannedCodes.add(scannedCode);
            scCountEl.textContent = taskState.scannedCount;

            // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
            finishBtn.style.display = 'inline-block';
            backBtn.style.display   = 'inline-block';

            // –∞–≤—Ç–æ–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
            if (taskState.scannedCount >= taskState.plannedQuantity) {
              finishBtn.click();
            }
          } else {
            window.AndroidAudio.playError();
            Swal.fire({ title: data.message, icon: 'error' });
          }
        })
        .catch(err => {
          window.AndroidAudio.playError();
          Swal.fire({ title: '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', text: err.message, icon: 'error' });
        });

        return;
      }


      
        // 3) –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–π —è—á–µ–π–∫–∏ (—Å–µ–∫—Ü–∏—è ¬´–ö—É–¥–∞¬ª)
        if (taskState.quantityConfirmed && !taskState.targetScanned) {
          processTargetScan(scannedCode);
          return;
        }
      };
      
    

    function processSourceScan(scannedCode) {
  fetch('/transfer/validate_source', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({cell_code: scannedCode, task_id: TASK_ID})
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      window.AndroidAudio.playSuccess();
      // –í–ê–ñ–ù–û: —Å–Ω–∞—á–∞–ª–∞ —Å—Ç–∞–≤–∏–º —Ñ–ª–∞–≥
      taskState.sourceScanned = true;

      // –î–∞–ª—å—à–µ –≤–∞—à UI‚Äë–∫–æ–¥
      document.getElementById('sourceSection').classList.add('confirmed');
      document.getElementById('sourceCell').classList.add('confirmed-cell');
      quantitySection.style.display = 'block';
      quantitySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
      window.AndroidAudio.playError();
      sourceStatusEl.textContent = data.message;
      sourceStatusEl.style.color = 'red';
      setTimeout(() => sourceStatusEl.textContent = '', 2000);
    }
  });
}


// –∑–∞–º–µ–Ω–∏—Ç–µ —Ç–µ–∫—É—â—É—é —Ñ—É–Ω–∫—Ü–∏—é processTargetScan –Ω–∞:
function processTargetScan(scannedCode) {
  fetch('/transfer/validate_target', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({cell_code: scannedCode, task_id: TASK_ID})
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      window.AndroidAudio.playSuccess();
      // UI-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      document.getElementById('targetSection').classList.add('confirmed');
      document.getElementById('targetCell').classList.add('confirmed-cell');
      targetStatusEl.textContent = '–Ø—á–µ–π–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞';
      targetStatusEl.style.color = 'green';
      // —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ–º update_task
      return fetch('/transfer/update_task', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          id_task: TASK_ID,
          counts: taskState.scannedCount
        })
      });
    } else {
      window.AndroidAudio.playError();
      throw new Error(data.message);
    }
  })
  .then(res => res.json())
  .then(res => {
    if (res.status === 'success') {
      if (res.remaining_tasks === 0) {
        // –ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ split_order –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–∫–∞–∑–∞
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('split_order') }}";
  
        form.innerHTML = `
          <input type="hidden" name="order_id" value="${res.order_id}">
          <input type="hidden" name="turn"     value="{{ queue }}">
        `;
        document.body.appendChild(form);
        form.submit();
      } else {
        // –ï—â—ë –µ—Å—Ç—å –∑–∞–¥–∞—á–∏ ‚Äî –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ç–∞—Å–∫—É
        window.location.href = `{{ url_for('transfer') }}?queue={{ queue }}&mode={{ mode }}`;
      }
    } else {
      Swal.fire({ title: res.message || '–û—à–∏–±–∫–∞', icon: 'error' });
    }
  })
  
  .catch(err => Swal.fire({ title: '–û—à–∏–±–∫–∞', text: err.message, icon: 'error' }));
}

  // –û–±—â–∏–π —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∫–Ω–æ–ø–∫–æ–π ¬´–ù–∞–∑–∞–¥¬ª
  const backBtn       = document.getElementById('backToScan');
  const scannedCount  = document.getElementById('scannedCount');
  const finishBtn     = document.getElementById('finishScan');
  const quantitySec   = document.getElementById('quantitySection');
  <!-- const quantityInput = quantitySec.querySelector('input[type="number"]'); -->
  const confirmBtn    = quantitySec.querySelector('.btn.finish-scan') || quantitySec.querySelector('.btn');
  const countCard     = document.getElementById('countCard');
  const targetSec     = document.getElementById('targetSection');

  backBtn.addEventListener('click', async function(e) {
    e.preventDefault();

    // 1) (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Å–±—Ä–æ—Å–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    try { await fetch("{{ url_for('clear_scans') }}", { method: 'POST' }); } 
    catch (err) { console.warn('–°–µ—Ä–≤–µ—Ä–Ω—ã–π —Å–±—Ä–æ—Å –Ω–µ –ø—Ä–æ—à—ë–ª:', err); }

    // 2) –°–±—Ä–æ—Å client-side —Å–æ—Å—Ç–æ—è–Ω–∏—è
    taskState.scannedCount      = 0;
    taskState.scannedCodes      = new Set();
    taskState.quantityConfirmed = false;

    // 3) –û–±–Ω—É–ª–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –∏ —Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É ¬´–ì–æ—Ç–æ–≤–æ¬ª
    scannedCount.textContent = '0';
    if (finishBtn) finishBtn.style.display = 'none';

    // 4) –í–µ—Ä–Ω—É—Ç—å —Å–µ–∫—Ü–∏—é ¬´–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ¬ª –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –≤–∏–¥—É
    quantitySec.classList.remove('confirmed', 'grayed');
    quantityInput.value    = '';
    quantityInput.disabled = false;
    confirmBtn.disabled    = false;

    // 5) –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É ¬´–®—Ç—É–∫¬ª
    countCard.style.background = '#ff3c00';
    countCard.querySelector('.card-value').textContent = "{{ task.counts }}";

    // 6) –°–∫—Ä—ã—Ç—å —Å–µ–∫—Ü–∏—é ¬´–ö—É–¥–∞¬ª
    targetSec.classList.add('hidden');
  });


  confirmQtyBtn.addEventListener('click', function() {
    const qty = parseInt(quantityInput.value, 10);
    if (qty === taskState.plannedQuantity) {
      // –ø–æ–ª–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
      taskState.quantityConfirmed = true;
      quantitySection.classList.add('confirmed');
      quantityInput.disabled = true;
      confirmQtyBtn.disabled = true;
    } else if (qty < taskState.plannedQuantity) {
      // –º–µ–Ω—å—à–µ, —á–µ–º –Ω—É–∂–Ω–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
      Swal.fire({
        title: '–í—ã —É–≤–µ—Ä–µ–Ω—ã?',
        text: '–í–≤–µ–¥–µ–Ω–æ –º–µ–Ω—å—à–µ —Ç—Ä–µ–±—É–µ–º–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '–î–∞, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
      }).then(result => {
        if (result.isConfirmed) {
          taskState.quantityConfirmed = true;
          // –ø–æ–º–µ–Ω—è—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ ¬´–®—Ç—É–∫¬ª
          const countCard = document.getElementById('countCard');
          countCard.style.background = 'maroon';
          countCard.querySelector('.card-value').textContent = qty + ' !';
          quantitySection.classList.add('confirmed');
          quantityInput.disabled = true;
          confirmQtyBtn.disabled = true;
        }
      });
    } else {
      // –≤–≤–µ–¥–µ–Ω–æ –±–æ–ª—å—à–µ, —á–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–æ—Å—å
      Swal.fire({
        icon: 'error',
        title: '–û—à–∏–±–∫–∞',
        text: '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞!'
      });
    }
  });


    // –æ—Ç–∫—Ä—ã–≤–∞–µ–º/–∑–∞–∫—Ä—ã–≤–∞–µ–º section-popup –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ section-info
    document.querySelectorAll('.section-info').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const popup = document.getElementById(btn.dataset.target);
        popup.style.display = (popup.style.display === 'block') ? 'none' : 'block';
      });
    });
    // –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø –ø–æ –∫–ª–∏–∫—É –≤ –ª—é–±–æ–º –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ
    document.addEventListener('click', () => {
      document.querySelectorAll('.section-popup')
        .forEach(p => p.style.display = 'none');
    });
    const filterBtn = document.getElementById("filterBtn");
    const filterMenu = document.getElementById("filterMenu");

    filterBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      filterMenu.style.display = filterMenu.style.display === "block" ? "none" : "block";
    });

    document.addEventListener("click", () => {
      filterMenu.style.display = "none";
    });
    


  

  // –ö–Ω–æ–ø–∫–∞ ¬´–ì–æ—Ç–æ–≤–æ¬ª ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –±–ª–æ–∫—É ¬´–ö—É–¥–∞¬ª
  document.getElementById('finishScan').addEventListener('click', () => {
    // –∑–∞—Ç–µ–º–Ω—è–µ–º –∫–æ–ª-–≤–æ
    document.getElementById('quantitySection').classList.add('grayed');
  
    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ö—É–¥–∞
    const tgtSec = document.getElementById('targetSection');
    tgtSec.classList.remove('hidden');
  
    // –ø–ª–∞–≤–Ω–æ —Å–∫—Ä–æ–ª–ª–∏–º –∫ –Ω–µ–º—É
    tgtSec.scrollIntoView({ behavior: 'smooth', block: 'start' });
  
    // —Ñ–æ–∫—É—Å –Ω–∞ –∏–Ω–ø—É—Ç
    document.getElementById('targetInputField').focus();
  
    taskState.quantityConfirmed = true;
  });
  
  

  document.getElementById('saveTargetBtn').addEventListener('click', async () => {
    const counts = parseInt(document.getElementById('scannedCount').textContent);
    const planned = parseInt(document.getElementById('plannedCount').textContent);
    const idTask = Number("{{ task.task_number }}");

  
    const proceed = counts === planned || await Swal.fire({
      title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è!',
      text: `–í—ã –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª–∏ ${counts}, –ø–ª–∞–Ω ‚Äî ${planned}. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: '–î–∞',
      cancelButtonText: '–ù–µ—Ç'
    }).then(result => result.isConfirmed);
  
    if (!proceed) return;
  
    const response = await fetch('/transfer/update_task', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id_task: idTask, counts: counts })
    });
  
    const result = await response.json();
    if (result.status === 'success') {
      window.location.href = '/transfer'; // –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–µ
    } else {
      Swal.fire('–û—à–∏–±–∫–∞', result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É', 'error');
    }
  });

  </script>
</body>
</html>




































