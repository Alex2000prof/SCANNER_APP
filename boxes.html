{% extends 'layout.html' %} {% block title %}–ö–æ—Ä–æ–±–∫–∏{% endblock %} {% block
content %}

<style>
  .swal2-confirm-print,
  .swal2-cancel-print {
    min-width: 120px !important;
    height: 44px !important;
    font-size: 1.18em !important;
    padding: 0 20px !important;
    border-radius: 8px !important;
    font-weight: bold !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    box-sizing: border-box !important;
  }
  .swal2-confirm-print {
    background: linear-gradient(135deg, #ff4b2b, #ff7733) !important;
    color: #fff !important;
    margin-right: 8px !important;
  }
  .swal2-cancel-print {
    background: #bbb !important;
    color: #fff !important;
    margin-left: 8px !important;
  }
</style>

<h2>–ü–æ—Å—Ç–∞–≤–∫–∞ ‚Ññ{{ delivery_id }}</h2>

<div style="text-align: center; margin-bottom: 16px">
  <button
    id="printLabelBtn"
    class="icon-btn"
    style="
      background: linear-gradient(135deg, #ff3c00, #ff7733);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 64px;
      height: 64px;
      font-size: 2.4em;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(255, 60, 0, 0.16);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 14px auto;
    "
    title="–ü–µ—á–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏"
  >
    üñ®
  </button>
</div>

<!-- –í–∞—à —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–æ—Ä–æ–±–æ–∫ -->
<p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É:</p>
<ul class="box-list">
  {% for box in boxes %} {% set scanned = box.Scanned %} {% set total =
  box.Total %} {% if scanned >= total %} {% set box_class = 'completed' %} {%
  elif scanned == 0 %} {% set box_class = '' %} {% else %} {% set box_class =
  'partial' %} {% endif %}

  <li class="{{ box_class }}">
    <div class="box-info">
      <div class="box-title">–ö–æ—Ä–æ–±–∫–∞ ‚Ññ{{ box.NumCase }}</div>
      <div class="box-count">{{ scanned }}/{{ total }} —à—Ç.</div>
    </div>
    <!-- –ö–Ω–æ–ø–∫–∞ ¬´–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å¬ª -->
    <a class="scan-link" href="{{ url_for('scan_box', box_id=box.ID_Case) }}">
      –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å
    </a>
  </li>
  {% endfor %}
</ul>

<!-- –ö–Ω–æ–ø–∫–∞ ¬´–ó–∞–≤–µ—Ä—à–∏—Ç—å¬ª (–≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ –≤–≤–æ–¥ –ø–æ—Å—Ç–∞–≤–∫–∏) -->
<form method="POST" action="/finish">
  <button type="submit">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
</form>

<hr />

<!-- –ù–æ–≤–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞: –µ—Å–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å:
     - "1677" (–±–µ–∑ –¥–µ—Ñ–∏—Å–∞) => —Å—á–∏—Ç–∞–µ–º ¬´–Ω–æ–º–µ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏¬ª, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ /boxes (–¥—Ä—É–≥–æ–π)
     - "01677-007" (—Å –¥–µ—Ñ–∏—Å–æ–º) => —Å—á–∏—Ç–∞–µ–º InnerBarcode, –ø–µ—Ä–µ—Ö–æ–¥–∏–º —Å—Ä–∞–∑—É –≤ –Ω—É–∂–Ω—É—é –∫–æ—Ä–æ–±–∫—É
-->
<!-- ... –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã boxes.html ... -->

<hr />

<div class="search-container">
  <h3 class="search-title">–ü–µ—Ä–µ–π—Ç–∏ –∫ –¥—Ä—É–≥–æ–π –ø–æ—Å—Ç–∞–≤–∫–µ –∏–ª–∏ –∫–æ—Ä–æ–±–∫–µ</h3>
  <form id="boxesSearchForm" method="POST" action="/boxes/search">
    <input
      type="text"
      id="boxesSearchInput"
      name="boxes_search"
      required
      placeholder="–ù–∞–ø—Ä. 1677 –∏–ª–∏ 01677-007"
      class="search-input"
    />
    <button type="submit" class="btn search-btn">–ü–æ–∏—Å–∫</button>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // --- –û–ë–™–Ø–í–õ–Ø–ï–ú –í–°–ï –≠–õ–ï–ú–ï–ù–¢–´ –û–î–ò–ù –†–ê–ó ---
  const boxesSearchForm = document.getElementById("boxesSearchForm");
  const boxesSearchInput = document.getElementById("boxesSearchInput");
  const printBtn = document.getElementById("printLabelBtn");

  // --- –ì–õ–ê–ó –í–°–ï–ì–î–ê –°–í–ï–†–•–£, –§–û–ö–£–° –î–õ–Ø –°–ö–ê–ù–ê ---
  document.addEventListener("DOMContentLoaded", () => {
    window.scrollTo(0, 0);
    setTimeout(() => {
      if (!window._disableAutoFocus && boxesSearchInput) {
        // –§–æ–∫—É—Å –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞
        boxesSearchInput.focus({ preventScroll: true });
      }
    }, 400);
  });

  // --- SweetAlert2 –ú–û–î–ê–õ–ö–ê ---
  printBtn.addEventListener("click", async function (e) {
    e.preventDefault();
    window._disableAutoFocus = true;

    const { value: count } = await Swal.fire({
      title: "–ü–µ—á–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–æ–∫",
      html: `
      <input id="swal-input-count"
        class="swal2-input"
        type="number"
        min="1"
        placeholder="–ö–æ–ª-–≤–æ"
        style="width: 100px; padding: 5px 7px; font-size: 1.08em; border-radius: 7px; border: 1.5px solid #ffa94d; text-align: center; margin: 0 auto;" />`,
      showCancelButton: true,
      confirmButtonText: "–ü–µ—á–∞—Ç—å",
      cancelButtonText: "–û—Ç–º–µ–Ω–∞",
      focusConfirm: false,
      customClass: {
        confirmButton: "swal2-confirm-print",
        cancelButton: "swal2-cancel-print",
      },
      preConfirm: () => {
        const value = parseInt(
          document.getElementById("swal-input-count").value,
          10
        );
        if (!value || value < 1) {
          Swal.showValidationMessage("–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!");
          return false;
        }
        return value;
      },
      didClose: () => {
        window._disableAutoFocus = false;
        // –í–µ—Ä–Ω—É—Ç—å —Ñ–æ–∫—É—Å –Ω–∞ —Å–∫–∞–Ω —Å preventScroll
        boxesSearchInput.focus({ preventScroll: true });
      },
    });

    if (count && count > 0) {
      try {
        const res = await fetch("/boxes/print_box", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ count: count }),
        });
        const js = await res.json();
        Swal.fire({
          icon: js.status === "success" ? "success" : "error",
          title:
            js.status === "success"
              ? "–ü–µ—á–∞—Ç—å –∑–∞–ø—É—â–µ–Ω–∞!"
              : js.error || js.message || "–û—à–∏–±–∫–∞",
          timer: 1600,
          showConfirmButton: false,
          toast: true,
          position: "top-end",
        });
      } catch {
        Swal.fire({
          icon: "error",
          title: "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º",
          timer: 1700,
          showConfirmButton: false,
          toast: true,
          position: "top-end",
        });
      }
    }
  });

  // --- –ê–í–¢–û–°–ê–ë–ú–ò–¢ –ü–û –í–°–¢–ê–í–ö–ï (–°–ö–ê–ù–ï–†–´) ---
  boxesSearchInput.addEventListener("paste", function (e) {
    setTimeout(() => {
      const code = boxesSearchInput.value.trim();
      if (code) {
        boxesSearchForm.submit();
      }
    }, 100);
  });

  // --- –§–û–ö–£–° –ü–û F9 ---
  document.addEventListener("keydown", (e) => {
    if (e.key === "F9") {
      e.preventDefault();
      boxesSearchInput.focus({ preventScroll: true });
    }
  });

  // --- –í–û–ó–í–†–ê–©–ï–ù–ò–ï –§–û–ö–£–°–ê –ü–û–°–õ–ï BLUR ---
  boxesSearchInput.addEventListener("blur", () => {
    setTimeout(() => {
      if (
        document.activeElement !== boxesSearchInput &&
        !window._disableAutoFocus
      ) {
        boxesSearchInput.focus({ preventScroll: true });
      }
    }, 200);
  });

  // --- –û–ë–†–ê–ë–û–¢–ö–ê –í–ù–ï–®–ù–ï–ì–û –°–ö–ê–ù–ê ---
  window.onBarcodeScanned = function (scannedCode) {
    boxesSearchInput.value = scannedCode;
    boxesSearchForm.submit();
  };
</script>

{% endblock %}
